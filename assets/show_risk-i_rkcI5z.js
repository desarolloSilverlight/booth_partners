import{r as m,f as Q,i as le,j as e}from"./index-CJU5MQjK.js";import{B as ce,C as de}from"./BaseCard-C-iVU7C9.js";import{I as xe}from"./search-CR5KhMAX.js";import{c as G}from"./config-BwmyTBcy.js";import{x as y}from"./xlsx.min-ejKjkcee.js";import{D as he,a as me,b as fe,p as T,c as pe}from"./purify.es-DvjEMyp2.js";import{S as ue,A as ge}from"./Snackbar-CfH3m9VF.js";import{T as be}from"./TableContainer-BqdrQOUD.js";import{T as ye,a as je,b as X,c as f,d as Ce}from"./TableRow-DOiG_nc3.js";import{B as I}from"./Button-BIdsfCL6.js";import{B as n,T as o}from"./Box-n9iJj8RL.js";import"./Card-Ct6aUZJP.js";import"./Paper-DuLtMsh8.js";import"./createSvgIcon-Cr6Zc33o.js";import"./useForkRef-B6FfdXhL.js";import"./ButtonBase-CejpV3EC.js";import"./Divider-CQ3OK35Z.js";import"./CardContent-Dv7cKb8W.js";import"./TextField-BpfY5uKK.js";import"./useSlot-xazagwgq.js";import"./resolveComponentProps-DPIZlf2G.js";import"./useId-DE-kZWW2.js";import"./useFormControl-DUBBWsnW.js";import"./isHostComponent-DzRytwJ7.js";import"./FormControl-CoKhAxmx.js";import"./isMuiElement-DjPusY45.js";import"./Menu-Bof1kA2Y.js";import"./mergeSlotProps-BP1cH13_.js";import"./createChainedFunction-BO_9K8Jh.js";import"./useControlled-BYV30LQr.js";import"./InputAdornment-FpvjlzrZ.js";import"./IconButton-B5dw_sXu.js";import"./CircularProgress-CjQlrGo0.js";import"./Close-BhbCqjDF.js";const it=()=>{const[w,R]=m.useState([]),[_,j]=m.useState([]);Q();const[u,B]=m.useState(""),L=le(),V=new URLSearchParams(Q().search),[v,N]=m.useState([]),[g,D]=m.useState(null),[Se,Y]=m.useState(!0),[Z,z]=m.useState(!1),[ee,F]=m.useState(!1),[a,O]=m.useState(null),[te,P]=m.useState(null),W=V.get("risk");m.useEffect(()=>{const t=sessionStorage.getItem("token");if(!t){alert("Token defeated, enter again"),L("/auth/login");return}const s=new Headers;s.append("authToken",t),s.append("Content-Type","application/json");const h={method:"POST",headers:s,body:JSON.stringify({risk:W}),redirect:"follow"};C(`Show All Risks In ${W}`,"success"),fetch(`${G.rutaApi}show_risks`,h).then(i=>i.status===401?A():i.json()).then(i=>{if(i.error)throw new Error(i.error);if(i.message){C(i.message,"info"),j([]),R([]);return}const l=i.dataRisks||i;if(!Array.isArray(l))throw new Error("Invalid data format received from server");const c=l.map(d=>({id:d.fkid_employe||d.id||0,fullName:d.full_name||"N/A",customer:d.customer||"N/A",calification:(()=>{try{const p=typeof d.calification=="string"?JSON.parse(d.calification.replace(/'/g,'"')):d.calification;return(p==null?void 0:p.Nivel)||""}catch{return""}})(),clasification:d.clasification||"N/A",attrition_probability:d.attrition_probability||"N/A",text_ai:d.text_ai||"No additional info"}));R(c),j(c)}).catch(i=>{i.message!=="Unauthorized"&&(C(i.message||"Error in process","error"),console.error(i))}).finally(()=>Y(!1))},[]);const C=(t,s)=>{N(x=>[...x,{msg:t,severity:s}])};m.useEffect(()=>{if(u==="")j(w);else{const t=w.filter(s=>s.fullName.toLowerCase().includes(u.toLowerCase())||s.customer.toLowerCase().includes(u.toLowerCase()));j(t)}},[u,w]),m.useEffect(()=>{if(!g&&v.length>0){const t=v[0];D(t),N(s=>s.slice(1)),z(!0)}},[v,g]);const se=()=>{const t=_.map(i=>({"Full Name":i.fullName,Customer:i.customer,Perception:i.calification,"Analysis Result":i.clasification,"Attrition Probability":i.attrition_probability})),s=y.utils.json_to_sheet(t);Object.keys(t[0]).forEach((i,l)=>{const c=y.utils.encode_cell({r:0,c:l});s[c]&&(s[c].s={fill:{fgColor:{rgb:"B8CCE4"}},font:{color:{rgb:"222222"},bold:!1},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}})});const h=y.utils.book_new();y.utils.book_append_sheet(h,s,"Predictive Analysis"),y.writeFile(h,"report_per_risk.xlsx",{bookType:"xlsx"})},H=(t,s)=>{s!=="clickaway"&&(z(!1),D(null))},A=()=>{throw C("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),L("/auth/login"),new Error("Unauthorized")},ie=t=>{O(t),F(!0),P(null);try{const s=sessionStorage.getItem("token");if(!s)return A();const x=new Headers;x.append("authToken",s),x.append("Content-Type","application/json");const h={method:"POST",headers:x,body:JSON.stringify({id:t.id}),redirect:"follow"};fetch(`${G.rutaApi}employees_profile`,h).then(i=>i.status===401?A():i.json()).then(i=>{const l=i==null?void 0:i.dataEmployee,c=Array.isArray(l)?l[0]:l;if(c){const d=c.salary_level??c.salaryLevel??null;P(d)}}).catch(i=>{console.error("Error fetching employee profile:",i)})}catch(s){console.error(s)}},$=()=>{F(!1),O(null)},re=t=>{var s,x,h,i,l,c;return t?{brief:(((s=t.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:s[1])||"").trim(),riskLevel:(((x=t.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:x[1])||"").trim(),drivers:(((h=t.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:h[1])||"").trim(),sentiment:(((i=t.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:i[1])||"").trim(),assessment:(((l=t.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:l[1])||"").trim(),actions:ne((((c=t.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:c[1])||"").trim())}:{}},ne=t=>{if(!t)return"";let s=String(t);const x=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return s=s.replace(x,(h,i)=>`<b>${i.trim()}:</b> `),s.trim()},S=t=>t?t.split(/\n|\. /).map(s=>s.replace(/\*\*|^-|\d+$/g,"").trim()).filter(s=>s.length>0):[],U=(t,s)=>{if(!t)return"";const x=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),h=new RegExp(`<b>\\s*${x}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),i=t.match(h);return i?i[1].trim():""},r=a!=null&&a.text_ai?re(a.text_ai):null,J=r!=null&&r.drivers?S(r.drivers):[],M=r!=null&&r.sentiment?S(r.sentiment):[],q=r!=null&&r.assessment?S(r.assessment):[],K=r!=null&&r.actions?S(r.actions):[],k=r!=null&&r.actions?U(r.actions,"Controllable by Us"):"",E=r!=null&&r.actions?U(r.actions,"Controllable by the Client"):"",oe=t=>{const s=(t||"").toLowerCase(),x=/low|below/.test(s),h=/compet/i.test(s),i=/high|above/.test(s);let l="#ECEFF1",c="#E5E9EC",d="#455A64",p="#CFD8DC",ae=t||"N/A",b="";return x?(l="#FDE7E9",c="#FAD1D5",d="#7A0A1A",p="#F5B7BF",b="â¬‡ï¸"):h?(l="#FFF7E0",c="#FFE8B0",d="#8A5B00",p="#FFD777",b="âš–ï¸"):i&&(l="#E6F4EA",c="#D1EFE0",d="#0D4B3B",p="#B7E1C9",b="â¬†ï¸"),e.jsxs(n,{component:"span",sx:{display:"inline-flex",alignItems:"center",gap:1,px:1.25,py:.5,borderRadius:999,fontWeight:800,fontSize:13,color:d,border:`1px solid ${p}`,backgroundImage:`linear-gradient(135deg, ${l}, ${c})`,boxShadow:"0 2px 6px rgba(0,0,0,0.06) inset, 0 1px 2px rgba(0,0,0,0.04)"},children:[b&&e.jsx("span",{style:{lineHeight:1},children:b}),e.jsx("span",{children:ae})]})};return e.jsxs(e.Fragment,{children:[g&&e.jsx(ue,{open:Z,autoHideDuration:2e3,onClose:H,children:e.jsx(ge,{onClose:H,severity:g.severity,sx:{width:"100%"},children:g.msg})}),e.jsx(ce,{title:e.jsxs(n,{sx:{display:"flex",alignItems:"center",width:"100%",gap:{xs:2,sm:4},flexDirection:{xs:"column",sm:"row"},justifyContent:"space-between"},children:[e.jsx(o,{variant:"h5",children:"Show Risks"}),e.jsx(n,{sx:{flex:1,display:"flex",justifyContent:"center"},children:e.jsx(xe,{searchTerm:u,onSearchChange:B,onClearSearch:()=>B(""),placeholder:"Search by Name or Customer",width:250})}),e.jsx(I,{variant:"contained",color:"success",size:"small",onClick:se,sx:{minWidth:140},children:"Download Excel"})]}),children:e.jsx(be,{sx:{width:"100%",overflowX:"auto"},children:e.jsxs(ye,{"aria-label":"simple table",sx:{whiteSpace:"nowrap"},children:[e.jsx(je,{children:e.jsxs(X,{children:[e.jsx(f,{children:"No."}),e.jsx(f,{children:"Full Name"}),e.jsx(f,{children:"Customer"}),e.jsx(f,{children:"Perception"}),e.jsx(f,{children:"Analysis Result"}),e.jsx(f,{children:"Predictive Analysis"})]})}),e.jsx(Ce,{children:_.map((t,s)=>e.jsxs(X,{children:[e.jsx(f,{children:s+1}),e.jsx(f,{children:t.fullName}),e.jsx(f,{children:t.customer}),e.jsx(f,{children:t.calification}),e.jsx(f,{children:t.clasification}),e.jsx(f,{children:e.jsx(I,{size:"small",variant:"contained",sx:{mt:1,backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},onClick:()=>ie(t),children:"Show Text"})})]},t.id))})]})})}),e.jsx(he,{open:ee,onClose:$,maxWidth:"md",fullWidth:!0,children:a&&e.jsxs(e.Fragment,{children:[e.jsx(me,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:e.jsxs(n,{sx:{display:"flex",alignItems:{xs:"start",sm:"center"},justifyContent:"space-between",gap:2,flexDirection:{xs:"column",sm:"row"}},children:[e.jsxs(n,{children:[e.jsx(o,{variant:"h6",sx:{fontWeight:800,letterSpacing:.3},children:"ATTENTION: ATTRITION RISK INSIGHTS"}),e.jsxs(o,{variant:"subtitle2",sx:{opacity:.9},children:[a.fullName,a.customer?` - ${a.customer}`:""]})]}),e.jsx(de,{label:a.clasification,color:a.clasification.toLowerCase().includes("high")?"error":a.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{fontWeight:700}})]})}),e.jsxs(fe,{dividers:!0,children:[e.jsxs(n,{sx:{display:"flex",gap:2,mb:2,flexDirection:{xs:"column",md:"row"}},children:[e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Employee Overview"}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem"},children:"ðŸ¢"}),e.jsx(n,{children:e.jsxs(o,{variant:"body1",fontWeight:800,children:["Company: ",a.customer]})})]}),e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(o,{sx:{fontSize:"2rem"},children:a.calification==="Positive"?"ðŸ˜€":a.calification==="Negative"?"ðŸ˜ž":a.calification==="Neutral"?"ðŸ˜":"ðŸ¤¨"}),e.jsxs(n,{sx:{flex:1},children:[e.jsxs(o,{variant:"body1",fontWeight:800,gutterBottom:!0,children:["Sentiment Analysis: ",a.calification||"No comments to analyze"]}),M.length>0&&e.jsx(n,{children:M.map((t,s)=>e.jsx(o,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:t},s))})]})]})]}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Key Insights"}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem"},children:"ðŸ“ˆ"}),e.jsxs(n,{children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.25,mb:.5,flexWrap:"wrap"},children:[e.jsx(o,{variant:"body1",fontWeight:800,sx:{m:0},children:"Compensation Level:"}),oe(te)]}),e.jsx(o,{variant:"body2",sx:{color:"text.secondary"},children:"Based on current local market benchmark data"})]})]}),r&&J.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(o,{sx:{fontSize:"2rem"},children:a.clasification.toLowerCase().includes("high")?"âŒ":a.clasification.toLowerCase().includes("medium")?"âš ï¸":a.clasification.toLowerCase().includes("low")?"âœ…":"âšª"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"body1",fontWeight:800,gutterBottom:!0,children:"Prioritized Risk Drivers"}),J.map((t,s)=>e.jsxs(o,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:["â€¢ ",t]},s))]})]})]})]}),r&&q.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:q.map((t,s)=>e.jsx("li",{children:t},s))})]})]}),r&&(k||E)?e.jsxs(n,{children:[k&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ› ï¸"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:T.sanitize(k)}})]})]}),E&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ¤"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:T.sanitize(E)}})]})]})]}):r&&K.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“Š"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:K.map((t,s)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:T.sanitize(t)}},s))})]})]}),!r&&e.jsx(o,{children:"No analysis available."})]}),e.jsx(pe,{children:e.jsx(I,{onClick:$,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{it as default};
