import{r as m,i as ue,j as e}from"./index-vVrmdSAi.js";import{B as v,C as ge}from"./BaseCard-CHoophF0.js";import{c as Q}from"./config-DOW8WNQj.js";import{I as be}from"./search-Bk592vgg.js";import{a as je}from"./dayjs.min-m-0oNQ7s.js";import{x as b}from"./xlsx.min-cbRSGu3v.js";import{p as R}from"./purify.es-DxJI3Wx7.js";import{T as r,B as o}from"./Box-Dmp19RYy.js";import{S as ye}from"./Snackbar-1cNWqJnu.js";import{A as Ce}from"./Alert-DHv-Uhwv.js";import{T as Z,a as V,b as X,c as w,d as x,e as ee}from"./TableRow-DkdFhzZT.js";import{B as z}from"./Button-DACH_hqE.js";import{D as Se,a as ve,b as we,c as Ae}from"./DialogTitle-B-M4zoiH.js";import"./Card-BOVImWUe.js";import"./Paper-MwjgWMcl.js";import"./createSvgIcon-BaC4K_Lt.js";import"./useForkRef-DlMLD4qL.js";import"./ButtonBase-CN8m9IWH.js";import"./Divider-BlS2FaE6.js";import"./CardContent-sb6ukAQg.js";import"./TextField-sKypHOK1.js";import"./useSlot-CSLy36Ib.js";import"./resolveComponentProps-CQBDKyOr.js";import"./useId-DPAP9_GE.js";import"./useFormControl-b64Gg9cs.js";import"./isHostComponent-WXvcE86W.js";import"./FormControl-BSQqFRE4.js";import"./isMuiElement-DBhawjF7.js";import"./Modal-mN-Hg11E.js";import"./ownerDocument-DW-IO8s5.js";import"./createChainedFunction-BO_9K8Jh.js";import"./Menu-BqF-Hgjk.js";import"./mergeSlotProps-CgYNNiq2.js";import"./useControlled-B21s8opx.js";import"./InputAdornment-C4rDm3xG.js";import"./IconButton-6ObsHBT5.js";import"./CircularProgress-BMD9XlnO.js";import"./Close-D6z-B9do.js";const dt=()=>{const[j,te]=m.useState([]),[p,A]=m.useState([]),[se,B]=m.useState(!0),[u,N]=m.useState(""),[k,F]=m.useState([]),[y,ie]=m.useState(null),[E,W]=m.useState(!1),O=ue(),[re,P]=m.useState(!1),[h,H]=m.useState(null),[ne,$]=m.useState(null),oe=je().subtract(1,"day").set("hour",17).set("minute",0).format("MMMM DD, YYYY, hh:mm A"),le=t=>{H(t),P(!0),$(null);try{const s=sessionStorage.getItem("token");if(!s)return _();const d=new Headers;d.append("authToken",s),d.append("Content-Type","application/json");const n={method:"POST",headers:d,body:JSON.stringify({id:t.id}),redirect:"follow"};fetch(`${Q.rutaApi}employees_profile`,n).then(l=>l.status===401?_():l.json()).then(l=>{const i=l==null?void 0:l.dataEmployee;if(i){const c=i.salary_level??i.salaryLevel??null;$(c)}}).catch(l=>{console.error("Error fetching employee profile:",l)})}catch(s){console.error(s)}},U=()=>{P(!1),H(null)};m.useEffect(()=>{if(!E&&k.length>0){const[t,...s]=k;ie(t),F(s),W(!0)}},[k,E]),m.useEffect(()=>{const t=sessionStorage.getItem("token");if(!t){C("Token defeated, enter again","error"),B(!1),O("/auth/login");return}const s=new Headers;s.append("authToken",t);const d={method:"GET",headers:s,redirect:"follow"};C("Show Analitics Attrition","success"),fetch(`${Q.rutaApi}show_metrics_analytics_attrition`,d).then(n=>n.status===401?_():n.json()).then(n=>{if(!n||!Array.isArray(n))throw new Error("Invalid response format");const l=n.map(i=>({id:i.fkid_employe,fullName:i.full_name||"",customer:i.customer||"",calification:(()=>{try{const c=typeof i.calification=="string"?JSON.parse(i.calification.replace(/'/g,'"')):i.calification;return(c==null?void 0:c.Nivel)||""}catch{return""}})(),clasification:i.clasification||"",attrition_probability:i.attrition_probability||"",text_ai:i.text_ai||""}));te(l),A(l)}).catch(n=>{n.message!=="Unauthorized"&&(C(n.message||"Error in process","error"),console.error(n))}).finally(()=>{B(!1)})},[]);const C=(t,s)=>{F(d=>[...d,{msg:t,severity:s}])},ae=()=>{const t=p.map(l=>({"Full Name":l.fullName,Customer:l.customer,Perception:l.calification,"Analysis Result":l.clasification,"Attrition Probability":l.attrition_probability})),s=b.utils.json_to_sheet(t);Object.keys(t[0]).forEach((l,i)=>{const c=b.utils.encode_cell({r:0,c:i});s[c]&&(s[c].s={fill:{fgColor:{rgb:"D9EDE3"}},font:{color:{rgb:"222222"},bold:!1},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}})});const n=b.utils.book_new();b.utils.book_append_sheet(n,s,"Predictive Analysis"),b.writeFile(n,"report_predictive_analysis.xlsx",{bookType:"xlsx"})},M=(t,s)=>{s!=="clickaway"&&W(!1)},_=()=>{throw C("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),O("/auth/login"),new Error("Unauthorized")};m.useEffect(()=>{if(u==="")A(j);else{const t=j.filter(s=>s.fullName.toLowerCase().includes(u.toLowerCase())||s.customer.toLowerCase().includes(u.toLowerCase()));A(t)}},[u,j]);const ce=t=>{N(t)},de=()=>{N("")};if(se)return e.jsx(v,{title:"Loading...",children:e.jsx(r,{children:"Show data..."})});if(j.length===0)return e.jsx(v,{title:"No data found",children:e.jsx(r,{children:"No data available for analysis."})});const L={low:p.filter(t=>t.clasification.toLowerCase().includes("low")).length,medium:p.filter(t=>t.clasification.toLowerCase().includes("medium")).length,high:p.filter(t=>t.clasification.toLowerCase().includes("high")).length},he=t=>{var s,d,n,l,i,c;return t?{brief:(((s=t.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:s[1])||"").trim(),riskLevel:(((d=t.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:d[1])||"").trim(),drivers:(((n=t.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:n[1])||"").trim(),sentiment:(((l=t.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:l[1])||"").trim(),assessment:(((i=t.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:i[1])||"").trim(),actions:xe((((c=t.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:c[1])||"").trim())}:{}},xe=t=>{if(!t)return"";let s=String(t);const d=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return s=s.replace(d,(n,l)=>`<b>${l.trim()}:</b> `),s.trim()},I=t=>t?t.split(/\n|\. /).map(s=>s.replace(/\*\*|^-|\d+$/g,"").trim()).filter(s=>s.length>0).map(s=>s.endsWith(".")?s:s+"."):[],me=t=>{if(!t)return[];const s=t.replace(/\r\n?/g,`
`).split(`
`).map(i=>i.trim()),d=[];let n="";const l=i=>/^(â€¢|\-|\*)\s+/.test(i)||/^(\d+\.|\([a-zA-Z]\))\s+/.test(i);for(const i of s){const c=i.trim();if(c)if(l(c)){if(n){const f=n.replace(/\s+/g," ").trim();d.push(/\.[\)\]]?$/.test(f)?f:f+".")}n=c.replace(/^((â€¢|\-|\*|\d+\.|\([a-zA-Z]\))\s+)/,"")}else if(n){const f=/[\w\)]$/.test(n);n+=(f?" ":"")+c}else n=c}if(n){const i=n.replace(/\s+/g," ").trim();d.push(/\.[\)\]]?$/.test(i)?i:i+".")}return d},Y=(t,s)=>{if(!t)return"";const d=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),n=new RegExp(`<b>\\s*${d}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),l=t.match(n);return l?l[1].trim():""},a=h!=null&&h.text_ai?he(h.text_ai):null,q=a!=null&&a.drivers?me(a.drivers):[],G=a!=null&&a.sentiment?I(a.sentiment):[],J=a!=null&&a.assessment?I(a.assessment):[],K=a!=null&&a.actions?I(a.actions):[],T=a!=null&&a.actions?Y(a.actions,"Controllable by Us"):"",D=a!=null&&a.actions?Y(a.actions,"Controllable by the Client"):"",fe=t=>{const s=(t||"").toLowerCase(),d=/low|below/.test(s),n=/compet/i.test(s),l=/high|above/.test(s);let i="#ECEFF1",c="#E5E9EC",f="#455A64",S="#CFD8DC",pe=t||"N/A",g="";return d?(i="#FDE7E9",c="#FAD1D5",f="#7A0A1A",S="#F5B7BF",g="â¬‡ï¸"):n?(i="#FFF7E0",c="#FFE8B0",f="#8A5B00",S="#FFD777",g="âš–ï¸"):l&&(i="#E6F4EA",c="#D1EFE0",f="#0D4B3B",S="#B7E1C9",g="â¬†ï¸"),e.jsxs(o,{component:"span",sx:{display:"inline-flex",alignItems:"center",gap:1,px:1.25,py:.5,borderRadius:999,fontWeight:800,fontSize:13,color:f,border:`1px solid ${S}`,backgroundImage:`linear-gradient(135deg, ${i}, ${c})`,boxShadow:"0 2px 6px rgba(0,0,0,0.06) inset, 0 1px 2px rgba(0,0,0,0.04)"},children:[g&&e.jsx("span",{style:{lineHeight:1},children:g}),e.jsx("span",{children:pe})]})};return e.jsxs(e.Fragment,{children:[y&&e.jsx(ye,{open:E,autoHideDuration:2e3,onClose:M,children:e.jsx(Ce,{onClose:M,severity:y.severity,sx:{width:"100%"},children:y.msg})},y.msg),e.jsx(o,{mb:3,children:e.jsx(v,{title:e.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(r,{variant:"h5",children:"Overview of the analysis prediction"}),e.jsx(z,{variant:"contained",color:"success",size:"small",onClick:ae,sx:{ml:2,minWidth:140},children:"Download Excel"})]}),children:e.jsx(Z,{children:e.jsxs(V,{"aria-label":"risk counts",sx:{whiteSpace:"nowrap"},children:[e.jsx(X,{children:e.jsxs(w,{children:[e.jsx(x,{children:e.jsx(r,{variant:"subtitle1",children:"Low Risks"})}),e.jsx(x,{children:e.jsx(r,{variant:"subtitle1",children:"Medium Risks"})}),e.jsx(x,{children:e.jsx(r,{variant:"subtitle1",children:"High Risks"})})]})}),e.jsx(ee,{children:e.jsxs(w,{children:[e.jsx(x,{children:e.jsx(r,{fontWeight:600,color:"success.main",children:L.low})}),e.jsx(x,{children:e.jsx(r,{fontWeight:600,color:"warning.main",children:L.medium})}),e.jsx(x,{children:e.jsx(r,{fontWeight:600,color:"error.main",children:L.high})})]})})]})})})}),e.jsx(o,{mb:3,children:e.jsx(v,{title:e.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:2},children:[e.jsxs(o,{children:[e.jsx(r,{variant:"h5",children:"Predictive Attrition Analysis"}),e.jsxs(r,{variant:"body2",color:"textSecondary",sx:{fontStyle:"italic"},children:["Last update: ",oe," (Colombia Time)"]})]}),e.jsx(be,{searchTerm:u,onSearchChange:ce,onClearSearch:de,placeholder:"Analyzing ....",width:{xs:"100%",sm:300,md:400}})]}),children:e.jsx(Z,{children:e.jsxs(V,{"aria-label":"main table",sx:{whiteSpace:"nowrap"},children:[e.jsx(X,{children:e.jsxs(w,{children:[e.jsx(x,{children:"No."}),e.jsx(x,{children:"Full Name"}),e.jsx(x,{children:"Customer"}),e.jsx(x,{children:"Perception"}),e.jsx(x,{children:"Analysis result"}),e.jsx(x,{children:"Predictive analysis"})]})}),e.jsx(ee,{children:p.map((t,s)=>e.jsxs(w,{children:[e.jsx(x,{children:s+1}),e.jsx(x,{children:t.fullName}),e.jsx(x,{children:t.customer}),e.jsx(x,{children:t.calification}),e.jsx(x,{children:t.clasification}),e.jsx(x,{children:e.jsx(z,{size:"small",variant:"contained",sx:{mt:1,backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},onClick:()=>le(t),children:"Show Risk"})})]},t.id))})]})})})}),e.jsx(Se,{open:re,onClose:U,maxWidth:"md",fullWidth:!0,children:h&&e.jsxs(e.Fragment,{children:[e.jsx(ve,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:e.jsxs(o,{sx:{display:"flex",alignItems:{xs:"start",sm:"center"},justifyContent:"space-between",gap:2,flexDirection:{xs:"column",sm:"row"}},children:[e.jsxs(o,{children:[e.jsx(r,{variant:"h6",sx:{fontWeight:800,letterSpacing:.3},children:"ATTENTION: ATTRITION RISK INSIGHTS"}),e.jsxs(r,{variant:"subtitle2",sx:{opacity:.9},children:[h.fullName,h.customer?` - ${h.customer}`:""]})]}),e.jsx(ge,{label:h.clasification,color:h.clasification.toLowerCase().includes("high")?"error":h.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{fontWeight:700}})]})}),e.jsxs(we,{dividers:!0,children:[e.jsxs(o,{sx:{display:"flex",gap:2,mb:2,flexDirection:{xs:"column",md:"row"}},children:[e.jsxs(o,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Employee Overview"}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem"},children:"ðŸ¢"}),e.jsx(o,{children:e.jsxs(r,{variant:"body1",fontWeight:800,children:["Company: ",h.customer]})})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(r,{sx:{fontSize:"2rem"},children:h.calification==="Positive"?"ðŸ˜€":h.calification==="Negative"?"ðŸ˜ž":h.calification==="Neutral"?"ðŸ˜":"ðŸ¤¨"}),e.jsxs(o,{sx:{flex:1},children:[e.jsxs(r,{variant:"body1",fontWeight:800,gutterBottom:!0,children:["Sentiment Analysis: ",h.calification||"No comments to analyze"]}),G.length>0&&e.jsx(o,{children:G.map((t,s)=>e.jsx(r,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:t},s))})]})]})]}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Key Insights"}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem"},children:"ðŸ“ˆ"}),e.jsxs(o,{children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1.25,mb:.5,flexWrap:"wrap"},children:[e.jsx(r,{variant:"body1",fontWeight:800,sx:{m:0},children:"Compensation Level:"}),fe(ne)]}),e.jsx(r,{variant:"body2",sx:{color:"text.secondary"},children:"Based on current local market benchmark data"})]})]}),a&&q.length>0&&e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(r,{sx:{fontSize:"2rem"},children:h.clasification.toLowerCase().includes("high")?"âŒ":h.clasification.toLowerCase().includes("medium")?"âš ï¸":h.clasification.toLowerCase().includes("low")?"âœ…":"âšª"}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(r,{variant:"body1",fontWeight:800,gutterBottom:!0,children:"Prioritized Risk Drivers"}),q.map((t,s)=>e.jsxs(r,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:["â€¢ ",t]},s))]})]})]})]}),a&&J.length>0&&e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“"}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:J.map((t,s)=>e.jsx("li",{children:t},s))})]})]}),a&&(T||D)?e.jsxs(o,{children:[T&&e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ› ï¸"}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(o,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:R.sanitize(T)}})]})]}),D&&e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ¤"}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(o,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:R.sanitize(D)}})]})]})]}):a&&K.length>0&&e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“Š"}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:K.map((t,s)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:R.sanitize(t)}},s))})]})]}),!a&&e.jsx(r,{children:"No analysis available."})]}),e.jsx(Ae,{children:e.jsx(z,{onClick:U,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{dt as default};
