import{j as f,r as d,i as D}from"./index-c61RoRFK.js";import{c as v}from"./createSvgIcon-C3owckrH.js";import{B as E}from"./BaseCard-BJxMFc6A.js";import{c as H}from"./config-BwmyTBcy.js";import{x as i}from"./xlsx.min-CcRgR5y3.js";import{B,T as P}from"./Box-gDR6qJ3r.js";import{B as z}from"./Button-Di7pCCRT.js";import"./Card-BD9dg0Gx.js";import"./Paper-zWtH7ucq.js";import"./useForkRef-D6UyK2N_.js";import"./ButtonBase-DFHw14RL.js";import"./Divider-C_Y5NlQ7.js";import"./CardContent-D_JwTUZ-.js";import"./useId-CAERvijh.js";import"./CircularProgress-Beq4xJ7S.js";const L=v(f.jsx("path",{d:"M5 20h14v-2H5zM19 9h-4V3H9v6H5l7 7z"}),"Download"),M=[{label:`Employee
Perspective Report`,columns:["full_name","calification","text_ai"],fileName:"Report_Attrition_Perspective.xlsx"},{label:`Attrition Risk
Report per Client`,columns:["full_name","clasification","customer","text_ai"],fileName:"Report_Attrition_Risk_per_Client.xlsx"},{label:`Risk Count
Report per Client`,columns:[],fileName:"Risk_Count_Report_per_Client.xlsx",isCountReport:!0},{label:`Risk
by Percentage Report`,columns:[],fileName:"Risk_by_Percentage_Report.xlsx",isPercentageReport:!0}],oe=()=>{const[I,_]=d.useState(!0),w=D(),[N,b]=d.useState([]),[T,F]=d.useState(null),[m,S]=d.useState([]);d.useEffect(()=>{const o=sessionStorage.getItem("token");if(!o){c("Token defeated, enter again","error"),_(!1),w("/auth/login");return}const l=new Headers;l.append("authToken",o);const h={method:"GET",headers:l,redirect:"follow"};c("Show Analitics Attrition","success"),fetch(`${H.rutaApi}show_metrics_analytics_attrition`,h).then(s=>s.status===401?C():s.json()).then(s=>{if(!s||!Array.isArray(s))throw new Error("Invalid response format");S(s)}).catch(s=>{s.message!=="Unauthorized"&&console.error(s)}).finally(()=>{_(!1)})},[]);const c=(o,l)=>{b(h=>[...h,{msg:o,severity:l}])},C=()=>{throw c("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),w("/auth/login"),new Error("Unauthorized")},j=(o,l,h,s)=>{if(!m||m.length===0){c("No hay datos para descargar","error");return}if(h){const e={};m.forEach(r=>{const a=r.customer||"Sin Cliente",p=(r.clasification||"").toLowerCase();e[a]||(e[a]={Low:0,Medium:0,High:0}),p.includes("low")?e[a].Low+=1:p.includes("medium")?e[a].Medium+=1:p.includes("high")&&(e[a].High+=1)});const n=Object.entries(e).map(([r,a])=>({customer:r,Low:a.Low,Medium:a.Medium,High:a.High})),t=i.utils.json_to_sheet(n),u=i.utils.book_new();i.utils.book_append_sheet(u,t,"Sheet1"),i.writeFile(u,l),c("Descarga exitosa","success");return}if(s){let e=0,n=0,t=0,u=0;m.forEach(g=>{const x=(g.clasification||"").toLowerCase();x.includes("low")?e+=1:x.includes("medium")?n+=1:x.includes("high")&&(t+=1),u+=1});const r=g=>u>0?(g/u*100).toFixed(2)+"%":"0%",a=[{Low:r(e),Medium:r(n),High:r(t)}],p=i.utils.json_to_sheet(a),R=i.utils.book_new();i.utils.book_append_sheet(R,p,"Sheet1"),i.writeFile(R,l),c("Descarga exitosa","success");return}const y=m.map(e=>{const n={};return o.forEach(t=>{if(t==="calification")try{const r=String(e.calification).match(/'Nivel':\s*'([^']+)'/);n[t]=r?r[1]:""}catch{n[t]=""}else t==="clasification"?n[t]=e.clasification:t==="full_name"?n[t]=e.full_name:n[t]=e[t]}),n}),A=i.utils.json_to_sheet(y),k=i.utils.book_new();i.utils.book_append_sheet(k,A,"Sheet1"),i.writeFile(k,l),c("Descarga exitosa","success")};return f.jsx(E,{title:"Reports Page",children:f.jsx(B,{display:"flex",gap:2,mb:4,children:M.map((o,l)=>f.jsxs(z,{variant:"contained",onClick:()=>j(o.columns,o.fileName,o.isCountReport,o.isPercentageReport),sx:{backgroundColor:"#0D4B3B",color:"#fff",borderRadius:3,minWidth:180,minHeight:80,fontSize:18,fontWeight:500,textTransform:"none",boxShadow:2,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center","&:hover":{backgroundColor:"#0B3F32"}},children:[f.jsx(L,{sx:{fontSize:36,mb:1}}),f.jsx(P,{sx:{fontSize:16,fontWeight:500,whiteSpace:"pre-line",textAlign:"center"},children:o.label})]},l))})})};export{oe as default};
