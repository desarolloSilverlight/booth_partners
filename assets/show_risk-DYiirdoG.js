import{r as a,f as J,i as se,j as e}from"./index-a8kbXjkM.js";import{B as ie,C as re}from"./BaseCard-CaVKqiGQ.js";import{I as ne}from"./search-Dj58SK4A.js";import{c as oe}from"./config-BwmyTBcy.js";import{x as g}from"./xlsx.min-Dan2WnIl.js";import{D as le,a as ae,b as ce,p as A,c as de}from"./purify.es-CHLVRN25.js";import{S as me,A as he}from"./Snackbar-CIgrxjIL.js";import{T as xe}from"./TableContainer-sb6WmyXz.js";import{T as fe,a as ue,b as Q,c,d as pe}from"./TableRow-Bje9yeSC.js";import{B as R}from"./Button-BKx_4WKL.js";import{B as n,T as l}from"./Box-BxUS-AKn.js";import"./Card-BPtRDKI0.js";import"./Paper-D-RdRHSj.js";import"./createSvgIcon-kD1ZWZUU.js";import"./useForkRef-Dx36i4TJ.js";import"./ButtonBase-CdWBoicg.js";import"./Divider-BqRgsaQ7.js";import"./CardContent-ClSNjI8-.js";import"./TextField-BMV7h-2U.js";import"./useSlot-Dz5mhnmg.js";import"./resolveComponentProps-Bn6s_OOL.js";import"./useId-BmV5-Wjm.js";import"./useFormControl-DWTlw4CR.js";import"./isHostComponent-BePQffoO.js";import"./FormControl-BnFS-8lD.js";import"./isMuiElement-mFh1iwH4.js";import"./Menu-CEMCVjjb.js";import"./mergeSlotProps-CNS-LPbI.js";import"./createChainedFunction-BO_9K8Jh.js";import"./useControlled-DtlPQB9n.js";import"./InputAdornment-CAss5QvY.js";import"./IconButton-CsDBEJf6.js";import"./CircularProgress-BH9toPbs.js";import"./Close-BMRxtogn.js";const Ye=()=>{const[C,_]=a.useState([]),[I,b]=a.useState([]);J();const[u,T]=a.useState(""),N=se(),q=new URLSearchParams(J().search),[S,L]=a.useState([]),[p,z]=a.useState(null),[ge,G]=a.useState(!0),[K,B]=a.useState(!1),[X,D]=a.useState(!1),[o,P]=a.useState(null),E=q.get("risk");a.useEffect(()=>{const t=sessionStorage.getItem("token");if(!t){alert("Token defeated, enter again"),N("/auth/login");return}const s=new Headers;s.append("authToken",t),s.append("Content-Type","application/json");const m={method:"POST",headers:s,body:JSON.stringify({risk:E}),redirect:"follow"};j(`Show All Risks In ${E}`,"success"),fetch(`${oe.rutaApi}show_risks`,m).then(r=>r.status===401?Y():r.json()).then(r=>{if(r.error)throw new Error(r.error);if(r.message){j(r.message,"info"),b([]),_([]);return}const x=r.dataRisks||r;if(!Array.isArray(x))throw new Error("Invalid data format received from server");const f=x.map(h=>({id:h.id||0,fullName:h.full_name||"N/A",customer:h.customer||"N/A",calification:(()=>{try{const k=typeof h.calification=="string"?JSON.parse(h.calification.replace(/'/g,'"')):h.calification;return(k==null?void 0:k.Nivel)||""}catch{return""}})(),clasification:h.clasification||"N/A",attrition_probability:h.attrition_probability||"N/A",text_ai:h.text_ai||"No additional info"}));_(f),b(f)}).catch(r=>{r.message!=="Unauthorized"&&(j(r.message||"Error in process","error"),console.error(r))}).finally(()=>G(!1))},[]);const j=(t,s)=>{L(d=>[...d,{msg:t,severity:s}])};a.useEffect(()=>{if(u==="")b(C);else{const t=C.filter(s=>s.fullName.toLowerCase().includes(u.toLowerCase())||s.customer.toLowerCase().includes(u.toLowerCase()));b(t)}},[u,C]),a.useEffect(()=>{if(!p&&S.length>0){const t=S[0];z(t),L(s=>s.slice(1)),B(!0)}},[S,p]);const V=()=>{const t=I.map(r=>({"Full Name":r.fullName,Customer:r.customer,Perception:r.calification,"Analysis Result":r.clasification,"Attrition Probability":r.attrition_probability})),s=g.utils.json_to_sheet(t);Object.keys(t[0]).forEach((r,x)=>{const f=g.utils.encode_cell({r:0,c:x});s[f]&&(s[f].s={fill:{fgColor:{rgb:"B8CCE4"}},font:{color:{rgb:"222222"},bold:!1},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}})});const m=g.utils.book_new();g.utils.book_append_sheet(m,s,"Predictive Analysis"),g.writeFile(m,"report_per_risk.xlsx",{bookType:"xlsx"})},O=(t,s)=>{s!=="clickaway"&&(B(!1),z(null))},Y=()=>{throw j("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),N("/auth/login"),new Error("Unauthorized")},Z=t=>{P(t),D(!0)},W=()=>{D(!1),P(null)},ee=t=>{var s,d,m,r,x,f;return t?{brief:(((s=t.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:s[1])||"").trim(),riskLevel:(((d=t.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:d[1])||"").trim(),drivers:(((m=t.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:m[1])||"").trim(),sentiment:(((r=t.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:r[1])||"").trim(),assessment:(((x=t.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:x[1])||"").trim(),actions:te((((f=t.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:f[1])||"").trim())}:{}},te=t=>{if(!t)return"";let s=String(t);const d=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return s=s.replace(d,(m,r)=>`<b>${r.trim()}:</b> `),s.trim()},y=t=>t?t.split(/\n|\. /).map(s=>s.replace(/\*\*|^-|\d+$/g,"").trim()).filter(s=>s.length>0):[],H=(t,s)=>{if(!t)return"";const d=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),m=new RegExp(`<b>\\s*${d}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),r=t.match(m);return r?r[1].trim():""},i=o!=null&&o.text_ai?ee(o.text_ai):null,U=i!=null&&i.drivers?y(i.drivers):[],$=i!=null&&i.sentiment?y(i.sentiment):[],F=i!=null&&i.assessment?y(i.assessment):[],M=i!=null&&i.actions?y(i.actions):[],v=i!=null&&i.actions?H(i.actions,"Controllable by Us"):"",w=i!=null&&i.actions?H(i.actions,"Controllable by the Client"):"";return e.jsxs(e.Fragment,{children:[p&&e.jsx(me,{open:K,autoHideDuration:2e3,onClose:O,children:e.jsx(he,{onClose:O,severity:p.severity,sx:{width:"100%"},children:p.msg})}),e.jsx(ie,{title:e.jsxs(n,{sx:{display:"flex",alignItems:"center",width:"100%",gap:{xs:2,sm:4},flexDirection:{xs:"column",sm:"row"},justifyContent:"space-between"},children:[e.jsx(l,{variant:"h5",children:"Show Risks"}),e.jsx(n,{sx:{flex:1,display:"flex",justifyContent:"center"},children:e.jsx(ne,{searchTerm:u,onSearchChange:T,onClearSearch:()=>T(""),placeholder:"Search by Name or Customer",width:250})}),e.jsx(R,{variant:"contained",color:"success",size:"small",onClick:V,sx:{minWidth:140},children:"Download Excel"})]}),children:e.jsx(xe,{sx:{width:"100%",overflowX:"auto"},children:e.jsxs(fe,{"aria-label":"simple table",sx:{whiteSpace:"nowrap"},children:[e.jsx(ue,{children:e.jsxs(Q,{children:[e.jsx(c,{children:"No."}),e.jsx(c,{children:"Full Name"}),e.jsx(c,{children:"Customer"}),e.jsx(c,{children:"Perception"}),e.jsx(c,{children:"Analysis Result"}),e.jsx(c,{children:"Predictive Analysis"})]})}),e.jsx(pe,{children:I.map((t,s)=>e.jsxs(Q,{children:[e.jsx(c,{children:s+1}),e.jsx(c,{children:t.fullName}),e.jsx(c,{children:t.customer}),e.jsx(c,{children:t.calification}),e.jsx(c,{children:t.clasification}),e.jsx(c,{children:e.jsx(R,{size:"small",variant:"contained",sx:{mt:1,backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},onClick:()=>Z(t),children:"Show Text"})})]},t.id))})]})})}),e.jsx(le,{open:X,onClose:W,maxWidth:"md",fullWidth:!0,children:o&&e.jsxs(e.Fragment,{children:[e.jsxs(ae,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:["ATTRITION RISK INSIGHTS - ",o.fullName,e.jsx(re,{label:o.clasification,color:o.clasification.toLowerCase().includes("high")?"error":o.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{ml:2}})]}),e.jsxs(ce,{dividers:!0,children:[e.jsx(l,{variant:"h6",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),e.jsxs(n,{sx:{display:"flex",gap:2,mb:2},children:[e.jsxs(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:2,bgcolor:"grey.100",borderRadius:2,flex:1,minWidth:100},children:[e.jsx(l,{sx:{fontSize:"2rem",mb:1},children:"🏢"}),e.jsx(l,{variant:"body1",fontWeight:"bold",align:"center",children:o.customer})]}),e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2},children:[e.jsx(l,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:o.calification==="Positive"?"😀":o.calification==="Negative"?"😞":o.calification==="Neutral"?"😐":"🤨"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(l,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:o.calification==="Positive"?"Positive":o.calification==="Negative"?"Negative":o.calification==="Neutral"?"Neutral":"No comments to analyze"}),$.length>0&&e.jsx(n,{children:$.map((t,s)=>e.jsx(l,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:t},s))})]})]}),i&&U.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2,minWidth:280},children:[e.jsx(l,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:o.clasification.toLowerCase().includes("high")?"❌":o.clasification.toLowerCase().includes("medium")?"⚠️":o.clasification.toLowerCase().includes("low")?"✅":"⚪"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(l,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),U.map((t,s)=>e.jsxs(l,{variant:"body2",sx:{color:"text.secondary",mb:1},children:["• ",t]},s))]})]})]}),i&&F.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(l,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"📝"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:F.map((t,s)=>e.jsx("li",{children:t},s))})]})]}),i&&(v||w)?e.jsxs(n,{children:[v&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(l,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"🛠️"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:A.sanitize(v)}})]})]}),w&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(l,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"🤝"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:A.sanitize(w)}})]})]})]}):i&&M.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(l,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"📊"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:M.map((t,s)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:A.sanitize(t)}},s))})]})]}),!i&&e.jsx(l,{children:"No analysis available."})]}),e.jsx(de,{children:e.jsx(R,{onClick:W,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{Ye as default};
