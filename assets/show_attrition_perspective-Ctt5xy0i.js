import{r as x,i as he,f as xe,j as e}from"./index-c61RoRFK.js";import{B as k,C as fe}from"./BaseCard-BJxMFc6A.js";import{c as G}from"./config-BwmyTBcy.js";import{I as pe}from"./search-XWACNNuK.js";import{a as ue}from"./dayjs.min-BmLKr63Y.js";import{D as ge,a as be,b as ye,p as B,c as je}from"./purify.es-CRPC5bwh.js";import{T as o,B as n}from"./Box-gDR6qJ3r.js";import{S as Se,A as ve}from"./Snackbar-B7dsYuY1.js";import{T as Ce}from"./TableContainer-x5qRl9TW.js";import{T as we,a as Ae,b as J,c as f,d as Le}from"./TableRow-CZkHcVC8.js";import{B as K}from"./Button-Di7pCCRT.js";import"./Card-BD9dg0Gx.js";import"./Paper-zWtH7ucq.js";import"./createSvgIcon-C3owckrH.js";import"./useForkRef-D6UyK2N_.js";import"./ButtonBase-DFHw14RL.js";import"./Divider-C_Y5NlQ7.js";import"./CardContent-D_JwTUZ-.js";import"./TextField-CPKeoVJw.js";import"./useSlot-MByqjjN3.js";import"./resolveComponentProps-CL_1EyJ_.js";import"./useId-CAERvijh.js";import"./useFormControl-DvaG5NQm.js";import"./isHostComponent-CdAxFvx2.js";import"./FormControl-xr9gSJXb.js";import"./isMuiElement-TiuxXHz1.js";import"./Menu-CcB7RIDV.js";import"./mergeSlotProps-B9apfIWs.js";import"./createChainedFunction-BO_9K8Jh.js";import"./useControlled-BZSoD8fk.js";import"./InputAdornment-HNhBnErJ.js";import"./IconButton-FWKI9l2P.js";import"./CircularProgress-Beq4xJ7S.js";import"./Close-B9kuC8RT.js";const lt=()=>{var Y;const[b,Q]=x.useState([]),[Z,v]=x.useState([]),[V,D]=x.useState(!0),[u,E]=x.useState(""),[C,z]=x.useState([]),[y,X]=x.useState(null),[w,R]=x.useState(!1),[ee,_]=x.useState(!1),[m,N]=x.useState(null),[te,F]=x.useState(null),O=he(),se=xe(),p=((Y=new URLSearchParams(se.search).get("pers"))==null?void 0:Y.toLowerCase())||"all",re=ue().subtract(1,"day").set("hour",17).set("minute",0).format("MMMM DD, YYYY, hh:mm A"),ie=t=>{N(t),_(!0),F(null);try{const s=sessionStorage.getItem("token");if(!s)return A();const d=new Headers;d.append("authToken",s),d.append("Content-Type","application/json");const r={method:"POST",headers:d,body:JSON.stringify({id:t.id}),redirect:"follow"};fetch(`${G.rutaApi}employees_profile`,r).then(c=>c.status===401?A():c.json()).then(c=>{const l=c==null?void 0:c.dataEmployee;if(l){const a=l.salary_level??l.salaryLevel??null;F(a)}}).catch(c=>{console.error("Error fetching employee profile:",c)})}catch(s){console.error(s)}},$=()=>{_(!1),N(null)},j=(t,s)=>{z(d=>[...d,{msg:t,severity:s}])},A=()=>{throw j("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),O("/auth/login"),new Error("Unauthorized")};x.useEffect(()=>{if(!w&&C.length>0){const[t,...s]=C;X(t),z(s),R(!0)}},[C,w]),x.useEffect(()=>{const t=sessionStorage.getItem("token");if(!t){j("Token defeated, enter again","error"),D(!1),O("/auth/login");return}const s=new Headers;s.append("authToken",t);const d={method:"GET",headers:s,redirect:"follow"};j("Loading data...","info"),fetch(`${G.rutaApi}show_metrics_analytics_attrition`,d).then(r=>r.status===401?A():r.json()).then(r=>{if(!r||!Array.isArray(r))throw new Error("Invalid response format");const l=r.map(a=>({id:a.fkid_employe,fullName:a.full_name||"",customer:a.customer||"",calification:(()=>{try{const h=typeof a.calification=="string"?JSON.parse(a.calification.replace(/'/g,'"')):a.calification;return(h==null?void 0:h.Nivel)||""}catch{return""}})(),clasification:a.clasification||"",attrition_probability:a.attrition_probability||"",text_ai:a.text_ai||""})).filter(a=>{const h=a.calification.toLowerCase();return p==="positive"?h==="positive":p==="negative"?h==="negative":p==="neutral"?h==="neutral":p==="no_comment"?a.calification==="No comments to analyze":!0});Q(l),v(l)}).catch(r=>{r.message!=="Unauthorized"&&(j(r.message||"Error loading data","error"),console.error(r))}).finally(()=>{D(!1)})},[p]),x.useEffect(()=>{if(u==="")v(b);else{const t=b.filter(s=>s.fullName.toLowerCase().includes(u.toLowerCase())||s.customer.toLowerCase().includes(u.toLowerCase()));v(t)}},[u,b]);const P=(t,s)=>{s!=="clickaway"&&R(!1)},ne=t=>E(t),ae=()=>E("");if(V)return e.jsx(k,{title:"Loading...",children:e.jsx(o,{children:"Loading attrition data..."})});if(b.length===0)return e.jsx(k,{title:"No data found",children:e.jsx(o,{children:"No data available for this perception."})});const oe=t=>{var s,d,r,c,l,a;return t?{brief:(((s=t.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:s[1])||"").trim(),riskLevel:(((d=t.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:d[1])||"").trim(),drivers:(((r=t.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:r[1])||"").trim(),sentiment:(((c=t.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:c[1])||"").trim(),assessment:(((l=t.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:l[1])||"").trim(),actions:le((((a=t.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:a[1])||"").trim())}:{}},le=t=>{if(!t)return"";let s=String(t);const d=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return s=s.replace(d,(r,c)=>`<b>${c.trim()}:</b> `),s.trim()},L=t=>t?t.split(/\n|\. /).map(s=>s.replace(/\*\*|^-|\d+$/g,"").trim()).filter(s=>s.length>0).map(s=>s.endsWith(".")?s:s+"."):[],ce=t=>{if(!t)return[];const s=t.replace(/\r\n?/g,`
`).split(`
`).map(l=>l.trim()),d=[];let r="";const c=l=>/^(â€¢|\-|\*)\s+/.test(l)||/^(\d+\.|\([a-zA-Z]\))\s+/.test(l);for(const l of s){const a=l.trim();if(a)if(c(a)){if(r){const h=r.replace(/\s+/g," ").trim();d.push(/\.[\)\]]?$/.test(h)?h:h+".")}r=a.replace(/^((â€¢|\-|\*|\d+\.|\([a-zA-Z]\))\s+)/,"")}else if(r){const h=/[\w\)]$/.test(r);r+=(h?" ":"")+a}else r=a}if(r){const l=r.replace(/\s+/g," ").trim();d.push(/\.[\)\]]?$/.test(l)?l:l+".")}return d},W=(t,s)=>{if(!t)return"";const d=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=new RegExp(`<b>\\s*${d}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),c=t.match(r);return c?c[1].trim():""},i=m!=null&&m.text_ai?oe(m.text_ai):null,H=i!=null&&i.drivers?ce(i.drivers):[],U=i!=null&&i.sentiment?L(i.sentiment):[],M=i!=null&&i.assessment?L(i.assessment):[],q=i!=null&&i.actions?L(i.actions):[],I=i!=null&&i.actions?W(i.actions,"Controllable by Us"):"",T=i!=null&&i.actions?W(i.actions,"Controllable by the Client"):"",de=t=>{const s=(t||"").toLowerCase(),d=/low|below/.test(s),r=/compet/i.test(s),c=/high|above/.test(s);let l="#ECEFF1",a="#E5E9EC",h="#455A64",S="#CFD8DC",me=t||"N/A",g="";return d?(l="#FDE7E9",a="#FAD1D5",h="#7A0A1A",S="#F5B7BF",g="â¬‡ï¸"):r?(l="#FFF7E0",a="#FFE8B0",h="#8A5B00",S="#FFD777",g="âš–ï¸"):c&&(l="#E6F4EA",a="#D1EFE0",h="#0D4B3B",S="#B7E1C9",g="â¬†ï¸"),e.jsxs(n,{component:"span",sx:{display:"inline-flex",alignItems:"center",gap:1,px:1.25,py:.5,borderRadius:999,fontWeight:800,fontSize:13,color:h,border:`1px solid ${S}`,backgroundImage:`linear-gradient(135deg, ${l}, ${a})`,boxShadow:"0 2px 6px rgba(0,0,0,0.06) inset, 0 1px 2px rgba(0,0,0,0.04)"},children:[g&&e.jsx("span",{style:{lineHeight:1},children:g}),e.jsx("span",{children:me})]})};return e.jsxs(e.Fragment,{children:[y&&e.jsx(Se,{open:w,autoHideDuration:2e3,onClose:P,children:e.jsx(ve,{onClose:P,severity:y.severity,sx:{width:"100%"},children:y.msg})},y.msg),e.jsx(n,{mb:3,children:e.jsxs(k,{title:e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(o,{variant:"h5",textTransform:"capitalize",children:[p.replace("_"," ")," perception analysis"]}),e.jsxs(o,{variant:"body2",color:"textSecondary",children:["Last update: ",re," (Colombia Time)"]})]}),children:[e.jsx(pe,{searchTerm:u,onSearchChange:ne,onClearSearch:ae,placeholder:`Search in ${p} employees...`}),e.jsx(Ce,{sx:{mt:2},children:e.jsxs(we,{"aria-label":"filtered table",sx:{whiteSpace:"nowrap"},children:[e.jsx(Ae,{children:e.jsxs(J,{children:[e.jsx(f,{children:"No."}),e.jsx(f,{children:"Full Name"}),e.jsx(f,{children:"Customer"}),e.jsx(f,{children:"Perception"}),e.jsx(f,{children:"Analysis Result"}),e.jsx(f,{children:"Predictive analysis"})]})}),e.jsx(Le,{children:Z.map((t,s)=>e.jsxs(J,{children:[e.jsx(f,{children:s+1}),e.jsx(f,{children:t.fullName}),e.jsx(f,{children:t.customer}),e.jsx(f,{children:t.calification}),e.jsx(f,{children:t.clasification}),e.jsx(f,{children:e.jsx(K,{size:"small",variant:"contained",onClick:()=>ie(t),sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Show Risk"})})]},t.id))})]})})]})}),e.jsx(ge,{open:ee,onClose:$,maxWidth:"md",fullWidth:!0,children:m&&e.jsxs(e.Fragment,{children:[e.jsx(be,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:e.jsxs(n,{sx:{display:"flex",alignItems:{xs:"start",sm:"center"},justifyContent:"space-between",gap:2,flexDirection:{xs:"column",sm:"row"}},children:[e.jsxs(n,{children:[e.jsx(o,{variant:"h6",sx:{fontWeight:800,letterSpacing:.3},children:"ATTENTION: ATTRITION RISK INSIGHTS"}),e.jsxs(o,{variant:"subtitle2",sx:{opacity:.9},children:[m.fullName,m.customer?` - ${m.customer}`:""]})]}),e.jsx(fe,{label:m.clasification,color:m.clasification.toLowerCase().includes("high")?"error":m.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{fontWeight:700}})]})}),e.jsxs(ye,{dividers:!0,children:[e.jsxs(n,{sx:{display:"flex",gap:2,mb:2,flexDirection:{xs:"column",md:"row"}},children:[e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Employee Overview"}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem"},children:"ðŸ¢"}),e.jsx(n,{children:e.jsxs(o,{variant:"body1",fontWeight:800,children:["Company: ",m.customer]})})]}),e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(o,{sx:{fontSize:"2rem"},children:m.calification==="Positive"?"ðŸ˜€":m.calification==="Negative"?"ðŸ˜ž":m.calification==="Neutral"?"ðŸ˜":"ðŸ¤¨"}),e.jsxs(n,{sx:{flex:1},children:[e.jsxs(o,{variant:"body1",fontWeight:800,gutterBottom:!0,children:["Sentiment Analysis: ",m.calification||"No comments to analyze"]}),U.length>0&&e.jsx(n,{children:U.map((t,s)=>e.jsx(o,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:t},s))})]})]})]}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Key Insights"}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem"},children:"ðŸ“ˆ"}),e.jsxs(n,{children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.25,mb:.5,flexWrap:"wrap"},children:[e.jsx(o,{variant:"body1",fontWeight:800,sx:{m:0},children:"Compensation Level:"}),de(te)]}),e.jsx(o,{variant:"body2",sx:{color:"text.secondary"},children:"Based on current local market benchmark data"})]})]}),i&&H.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(o,{sx:{fontSize:"2rem"},children:m.clasification.toLowerCase().includes("high")?"âŒ":m.clasification.toLowerCase().includes("medium")?"âš ï¸":m.clasification.toLowerCase().includes("low")?"âœ…":"âšª"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"body1",fontWeight:800,gutterBottom:!0,children:"Prioritized Risk Drivers"}),H.map((t,s)=>e.jsxs(o,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:["â€¢ ",t]},s))]})]})]})]}),i&&M.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:M.map((t,s)=>e.jsx("li",{children:t},s))})]})]}),i&&(I||T)?e.jsxs(n,{children:[I&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ› ï¸"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:B.sanitize(I)}})]})]}),T&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ¤"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:B.sanitize(T)}})]})]})]}):i&&q.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“Š"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:q.map((t,s)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:B.sanitize(t)}},s))})]})]}),!i&&e.jsx(o,{children:"No analysis available."})]}),e.jsx(je,{children:e.jsx(K,{onClick:$,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{lt as default};
