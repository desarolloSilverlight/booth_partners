import{r as h,i as oe,j as e}from"./index-a8kbXjkM.js";import{B as C,C as ae}from"./BaseCard-CaVKqiGQ.js";import{c as ce}from"./config-BwmyTBcy.js";import{I as de}from"./search-Dj58SK4A.js";import{a as he}from"./dayjs.min-8vVxtEmQ.js";import{x as g}from"./xlsx.min-Dan2WnIl.js";import{D as xe,a as me,b as fe,p as I,c as ue}from"./purify.es-CHLVRN25.js";import{T as r,B as n}from"./Box-BxUS-AKn.js";import{S as ge,A as pe}from"./Snackbar-CIgrxjIL.js";import{T as Y}from"./TableContainer-sb6WmyXz.js";import{T as G,a as Q,b as S,c as a,d as q}from"./TableRow-Bje9yeSC.js";import{B as L}from"./Button-BKx_4WKL.js";import"./Card-BPtRDKI0.js";import"./Paper-D-RdRHSj.js";import"./createSvgIcon-kD1ZWZUU.js";import"./useForkRef-Dx36i4TJ.js";import"./ButtonBase-CdWBoicg.js";import"./Divider-BqRgsaQ7.js";import"./CardContent-ClSNjI8-.js";import"./TextField-BMV7h-2U.js";import"./useSlot-Dz5mhnmg.js";import"./resolveComponentProps-Bn6s_OOL.js";import"./useId-BmV5-Wjm.js";import"./useFormControl-DWTlw4CR.js";import"./isHostComponent-BePQffoO.js";import"./FormControl-BnFS-8lD.js";import"./isMuiElement-mFh1iwH4.js";import"./Menu-CEMCVjjb.js";import"./mergeSlotProps-CNS-LPbI.js";import"./createChainedFunction-BO_9K8Jh.js";import"./useControlled-DtlPQB9n.js";import"./InputAdornment-CAss5QvY.js";import"./IconButton-CsDBEJf6.js";import"./CircularProgress-BH9toPbs.js";import"./Close-BMRxtogn.js";const Ze=()=>{const[p,J]=h.useState([]),[f,v]=h.useState([]),[K,T]=h.useState(!0),[u,z]=h.useState(""),[w,D]=h.useState([]),[j,V]=h.useState(null),[k,N]=h.useState(!1),B=oe(),[X,P]=h.useState(!1),[l,E]=h.useState(null),Z=he().subtract(1,"day").set("hour",17).set("minute",0).format("MMMM DD, YYYY, hh:mm A"),ee=t=>{E(t),P(!0)},W=()=>{P(!1),E(null)};h.useEffect(()=>{if(!k&&w.length>0){const[t,...i]=w;V(t),D(i),N(!0)}},[w,k]),h.useEffect(()=>{const t=sessionStorage.getItem("token");if(!t){b("Token defeated, enter again","error"),T(!1),B("/auth/login");return}const i=new Headers;i.append("authToken",t);const x={method:"GET",headers:i,redirect:"follow"};b("Show Analitics Attrition","success"),fetch(`${ce.rutaApi}show_metrics_analytics_attrition`,x).then(o=>o.status===401?ie():o.json()).then(o=>{if(!o||!Array.isArray(o))throw new Error("Invalid response format");const c=o.map(d=>({id:d.fkid_employe,fullName:d.full_name||"",customer:d.customer||"",calification:(()=>{try{const m=typeof d.calification=="string"?JSON.parse(d.calification.replace(/'/g,'"')):d.calification;return(m==null?void 0:m.Nivel)||""}catch{return""}})(),clasification:d.clasification||"",attrition_probability:d.attrition_probability||"",text_ai:d.text_ai||""}));J(c),v(c)}).catch(o=>{o.message!=="Unauthorized"&&(b(o.message||"Error in process","error"),console.error(o))}).finally(()=>{T(!1)})},[]);const b=(t,i)=>{D(x=>[...x,{msg:t,severity:i}])},te=()=>{const t=f.map(c=>({"Full Name":c.fullName,Customer:c.customer,Perception:c.calification,"Analysis Result":c.clasification,"Attrition Probability":c.attrition_probability})),i=g.utils.json_to_sheet(t);Object.keys(t[0]).forEach((c,d)=>{const m=g.utils.encode_cell({r:0,c:d});i[m]&&(i[m].s={fill:{fgColor:{rgb:"D9EDE3"}},font:{color:{rgb:"222222"},bold:!1},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}})});const o=g.utils.book_new();g.utils.book_append_sheet(o,i,"Predictive Analysis"),g.writeFile(o,"report_predictive_analysis.xlsx",{bookType:"xlsx"})},O=(t,i)=>{i!=="clickaway"&&N(!1)},ie=()=>{throw b("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),B("/auth/login"),new Error("Unauthorized")};h.useEffect(()=>{if(u==="")v(p);else{const t=p.filter(i=>i.fullName.toLowerCase().includes(u.toLowerCase())||i.customer.toLowerCase().includes(u.toLowerCase()));v(t)}},[u,p]);const se=t=>{z(t)},re=()=>{z("")};if(K)return e.jsx(C,{title:"Loading...",children:e.jsx(r,{children:"Show data..."})});if(p.length===0)return e.jsx(C,{title:"No data found",children:e.jsx(r,{children:"No data available for analysis."})});const _={low:f.filter(t=>t.clasification.toLowerCase().includes("low")).length,medium:f.filter(t=>t.clasification.toLowerCase().includes("medium")).length,high:f.filter(t=>t.clasification.toLowerCase().includes("high")).length},ne=t=>{var i,x,o,c,d,m;return t?{brief:(((i=t.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:i[1])||"").trim(),riskLevel:(((x=t.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:x[1])||"").trim(),drivers:(((o=t.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:o[1])||"").trim(),sentiment:(((c=t.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:c[1])||"").trim(),assessment:(((d=t.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:d[1])||"").trim(),actions:le((((m=t.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:m[1])||"").trim())}:{}},le=t=>{if(!t)return"";let i=String(t);const x=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return i=i.replace(x,(o,c)=>`<b>${c.trim()}:</b> `),i.trim()},y=t=>t?t.split(/\n|\. /).map(i=>i.replace(/\*\*|^-|\d+$/g,"").trim()).filter(i=>i.length>0).map(i=>i.endsWith(".")?i:i+"."):[],H=(t,i)=>{if(!t)return"";const x=i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(`<b>\\s*${x}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),c=t.match(o);return c?c[1].trim():""},s=l!=null&&l.text_ai?ne(l.text_ai):null,U=s!=null&&s.drivers?y(s.drivers):[],M=s!=null&&s.sentiment?y(s.sentiment):[],$=s!=null&&s.assessment?y(s.assessment):[],F=s!=null&&s.actions?y(s.actions):[],A=s!=null&&s.actions?H(s.actions,"Controllable by Us"):"",R=s!=null&&s.actions?H(s.actions,"Controllable by the Client"):"";return e.jsxs(e.Fragment,{children:[j&&e.jsx(ge,{open:k,autoHideDuration:2e3,onClose:O,children:e.jsx(pe,{onClose:O,severity:j.severity,sx:{width:"100%"},children:j.msg})},j.msg),e.jsx(n,{mb:3,children:e.jsx(C,{title:e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(r,{variant:"h5",children:"Overview of the analysis prediction"}),e.jsx(L,{variant:"contained",color:"success",size:"small",onClick:te,sx:{ml:2,minWidth:140},children:"Download Excel"})]}),children:e.jsx(Y,{children:e.jsxs(G,{"aria-label":"risk counts",sx:{whiteSpace:"nowrap"},children:[e.jsx(Q,{children:e.jsxs(S,{children:[e.jsx(a,{children:e.jsx(r,{variant:"subtitle1",children:"Low Risks"})}),e.jsx(a,{children:e.jsx(r,{variant:"subtitle1",children:"Medium Risks"})}),e.jsx(a,{children:e.jsx(r,{variant:"subtitle1",children:"High Risks"})})]})}),e.jsx(q,{children:e.jsxs(S,{children:[e.jsx(a,{children:e.jsx(r,{fontWeight:600,color:"success.main",children:_.low})}),e.jsx(a,{children:e.jsx(r,{fontWeight:600,color:"warning.main",children:_.medium})}),e.jsx(a,{children:e.jsx(r,{fontWeight:600,color:"error.main",children:_.high})})]})})]})})})}),e.jsx(n,{mb:3,children:e.jsx(C,{title:e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:2},children:[e.jsxs(n,{children:[e.jsx(r,{variant:"h5",children:"Predictive Attrition Analysis"}),e.jsxs(r,{variant:"body2",color:"textSecondary",sx:{fontStyle:"italic"},children:["Last update: ",Z," (Colombia Time)"]})]}),e.jsx(de,{searchTerm:u,onSearchChange:se,onClearSearch:re,placeholder:"Analyzing ....",width:{xs:"100%",sm:300,md:400}})]}),children:e.jsx(Y,{children:e.jsxs(G,{"aria-label":"main table",sx:{whiteSpace:"nowrap"},children:[e.jsx(Q,{children:e.jsxs(S,{children:[e.jsx(a,{children:"No."}),e.jsx(a,{children:"Full Name"}),e.jsx(a,{children:"Customer"}),e.jsx(a,{children:"Perception"}),e.jsx(a,{children:"Analysis result"}),e.jsx(a,{children:"Predictive analysis"})]})}),e.jsx(q,{children:f.map((t,i)=>e.jsxs(S,{children:[e.jsx(a,{children:i+1}),e.jsx(a,{children:t.fullName}),e.jsx(a,{children:t.customer}),e.jsx(a,{children:t.calification}),e.jsx(a,{children:t.clasification}),e.jsx(a,{children:e.jsx(L,{size:"small",variant:"contained",sx:{mt:1,backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},onClick:()=>ee(t),children:"Show Risk"})})]},t.id))})]})})})}),e.jsx(xe,{open:X,onClose:W,maxWidth:"md",fullWidth:!0,children:l&&e.jsxs(e.Fragment,{children:[e.jsxs(me,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:["ATTRITION RISK INSIGHTS - ",l.fullName,e.jsx(ae,{label:l.clasification,color:l.clasification.toLowerCase().includes("high")?"error":l.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{ml:2}})]}),e.jsxs(fe,{dividers:!0,children:[e.jsx(r,{variant:"h6",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),e.jsxs(n,{sx:{display:"flex",gap:2,mb:2},children:[e.jsxs(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:2,bgcolor:"grey.100",borderRadius:2,flex:1,minWidth:100},children:[e.jsx(r,{sx:{fontSize:"2rem",mb:1},children:"ðŸ¢"}),e.jsx(r,{variant:"body1",fontWeight:"bold",align:"center",children:l.customer})]}),e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:l.calification==="Positive"?"ðŸ˜€":l.calification==="Negative"?"ðŸ˜ž":l.calification==="Neutral"?"ðŸ˜":"ðŸ¤¨"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:l.calification==="Positive"?"Positive":l.calification==="Negative"?"Negative":l.calification==="Neutral"?"Neutral":"No comments to analyze"}),M.length>0&&e.jsx(n,{children:M.map((t,i)=>e.jsx(r,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:t},i))})]})]}),s&&U.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2,minWidth:280},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:l.clasification.toLowerCase().includes("high")?"âŒ":l.clasification.toLowerCase().includes("medium")?"âš ï¸":l.clasification.toLowerCase().includes("low")?"âœ…":"âšª"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),U.map((t,i)=>e.jsxs(r,{variant:"body2",sx:{color:"text.secondary",mb:1},children:["â€¢ ",t]},i))]})]})]}),s&&$.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:$.map((t,i)=>e.jsx("li",{children:t},i))})]})]}),s&&(A||R)?e.jsxs(n,{children:[A&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ› ï¸"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:I.sanitize(A)}})]})]}),R&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ¤"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:I.sanitize(R)}})]})]})]}):s&&F.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“Š"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:F.map((t,i)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:I.sanitize(t)}},i))})]})]}),!s&&e.jsx(r,{children:"No analysis available."})]}),e.jsx(ue,{children:e.jsx(L,{onClick:W,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{Ze as default};
