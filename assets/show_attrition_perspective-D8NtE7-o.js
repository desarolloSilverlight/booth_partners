import{r as h,i as xe,f as he,j as e}from"./index-CJU5MQjK.js";import{B as k,C as me}from"./BaseCard-C-iVU7C9.js";import{c as G}from"./config-BwmyTBcy.js";import{I as fe}from"./search-CR5KhMAX.js";import{a as pe}from"./dayjs.min-Db8i2R4f.js";import{D as ue,a as ge,b as be,p as B,c as ye}from"./purify.es-DvjEMyp2.js";import{T as n,B as i}from"./Box-n9iJj8RL.js";import{S as je,A as Se}from"./Snackbar-CfH3m9VF.js";import{T as ve}from"./TableContainer-BqdrQOUD.js";import{T as Ce,a as we,b as J,c as f,d as Ae}from"./TableRow-DOiG_nc3.js";import{B as K}from"./Button-BIdsfCL6.js";import"./Card-Ct6aUZJP.js";import"./Paper-DuLtMsh8.js";import"./createSvgIcon-Cr6Zc33o.js";import"./useForkRef-B6FfdXhL.js";import"./ButtonBase-CejpV3EC.js";import"./Divider-CQ3OK35Z.js";import"./CardContent-Dv7cKb8W.js";import"./TextField-BpfY5uKK.js";import"./useSlot-xazagwgq.js";import"./resolveComponentProps-DPIZlf2G.js";import"./useId-DE-kZWW2.js";import"./useFormControl-DUBBWsnW.js";import"./isHostComponent-DzRytwJ7.js";import"./FormControl-CoKhAxmx.js";import"./isMuiElement-DjPusY45.js";import"./Menu-Bof1kA2Y.js";import"./mergeSlotProps-BP1cH13_.js";import"./createChainedFunction-BO_9K8Jh.js";import"./useControlled-BYV30LQr.js";import"./InputAdornment-FpvjlzrZ.js";import"./IconButton-B5dw_sXu.js";import"./CircularProgress-CjQlrGo0.js";import"./Close-BhbCqjDF.js";const ot=()=>{var Y;const[b,Q]=h.useState([]),[V,C]=h.useState([]),[X,E]=h.useState(!0),[u,D]=h.useState(""),[w,R]=h.useState([]),[y,Z]=h.useState(null),[A,_]=h.useState(!1),[ee,z]=h.useState(!1),[l,N]=h.useState(null),[te,F]=h.useState(null),O=xe(),se=he(),p=((Y=new URLSearchParams(se.search).get("pers"))==null?void 0:Y.toLowerCase())||"all",re=pe().subtract(1,"day").set("hour",17).set("minute",0).format("MMMM DD, YYYY, hh:mm A"),ie=t=>{N(t),z(!0),F(null);try{const s=sessionStorage.getItem("token");if(!s)return L();const d=new Headers;d.append("authToken",s),d.append("Content-Type","application/json");const o={method:"POST",headers:d,body:JSON.stringify({id:t.id}),redirect:"follow"};fetch(`${G.rutaApi}employees_profile`,o).then(c=>c.status===401?L():c.json()).then(c=>{const x=c==null?void 0:c.dataEmployee;if(x){const a=x.salary_level??x.salaryLevel??null;F(a)}}).catch(c=>{console.error("Error fetching employee profile:",c)})}catch(s){console.error(s)}},P=()=>{z(!1),N(null)},j=(t,s)=>{R(d=>[...d,{msg:t,severity:s}])},L=()=>{throw j("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),O("/auth/login"),new Error("Unauthorized")};h.useEffect(()=>{if(!A&&w.length>0){const[t,...s]=w;Z(t),R(s),_(!0)}},[w,A]),h.useEffect(()=>{const t=sessionStorage.getItem("token");if(!t){j("Token defeated, enter again","error"),E(!1),O("/auth/login");return}const s=new Headers;s.append("authToken",t);const d={method:"GET",headers:s,redirect:"follow"};j("Loading data...","info"),fetch(`${G.rutaApi}show_metrics_analytics_attrition`,d).then(o=>o.status===401?L():o.json()).then(o=>{if(!o||!Array.isArray(o))throw new Error("Invalid response format");const x=o.map(a=>({id:a.fkid_employe,fullName:a.full_name||"",customer:a.customer||"",calification:(()=>{try{const m=typeof a.calification=="string"?JSON.parse(a.calification.replace(/'/g,'"')):a.calification;return(m==null?void 0:m.Nivel)||""}catch{return""}})(),clasification:a.clasification||"",attrition_probability:a.attrition_probability||"",text_ai:a.text_ai||""})).filter(a=>{const m=a.calification.toLowerCase();return p==="positive"?m==="positive":p==="negative"?m==="negative":p==="neutral"?m==="neutral":p==="no_comment"?a.calification==="No comments to analyze":!0});Q(x),C(x)}).catch(o=>{o.message!=="Unauthorized"&&(j(o.message||"Error loading data","error"),console.error(o))}).finally(()=>{E(!1)})},[p]),h.useEffect(()=>{if(u==="")C(b);else{const t=b.filter(s=>s.fullName.toLowerCase().includes(u.toLowerCase())||s.customer.toLowerCase().includes(u.toLowerCase()));C(t)}},[u,b]);const W=(t,s)=>{s!=="clickaway"&&_(!1)},ne=t=>D(t),ae=()=>D("");if(X)return e.jsx(k,{title:"Loading...",children:e.jsx(n,{children:"Loading attrition data..."})});if(b.length===0)return e.jsx(k,{title:"No data found",children:e.jsx(n,{children:"No data available for this perception."})});const oe=t=>{var s,d,o,c,x,a;return t?{brief:(((s=t.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:s[1])||"").trim(),riskLevel:(((d=t.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:d[1])||"").trim(),drivers:(((o=t.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:o[1])||"").trim(),sentiment:(((c=t.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:c[1])||"").trim(),assessment:(((x=t.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:x[1])||"").trim(),actions:le((((a=t.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:a[1])||"").trim())}:{}},le=t=>{if(!t)return"";let s=String(t);const d=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return s=s.replace(d,(o,c)=>`<b>${c.trim()}:</b> `),s.trim()},S=t=>t?t.split(/\n|\. /).map(s=>s.replace(/\*\*|^-|\d+$/g,"").trim()).filter(s=>s.length>0).map(s=>s.endsWith(".")?s:s+"."):[],H=(t,s)=>{if(!t)return"";const d=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(`<b>\\s*${d}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),c=t.match(o);return c?c[1].trim():""},r=l!=null&&l.text_ai?oe(l.text_ai):null,$=r!=null&&r.drivers?S(r.drivers):[],U=r!=null&&r.sentiment?S(r.sentiment):[],M=r!=null&&r.assessment?S(r.assessment):[],q=r!=null&&r.actions?S(r.actions):[],I=r!=null&&r.actions?H(r.actions,"Controllable by Us"):"",T=r!=null&&r.actions?H(r.actions,"Controllable by the Client"):"",ce=t=>{const s=(t||"").toLowerCase(),d=/low|below/.test(s),o=/compet/i.test(s),c=/high|above/.test(s);let x="#ECEFF1",a="#E5E9EC",m="#455A64",v="#CFD8DC",de=t||"N/A",g="";return d?(x="#FDE7E9",a="#FAD1D5",m="#7A0A1A",v="#F5B7BF",g="â¬‡ï¸"):o?(x="#FFF7E0",a="#FFE8B0",m="#8A5B00",v="#FFD777",g="âš–ï¸"):c&&(x="#E6F4EA",a="#D1EFE0",m="#0D4B3B",v="#B7E1C9",g="â¬†ï¸"),e.jsxs(i,{component:"span",sx:{display:"inline-flex",alignItems:"center",gap:1,px:1.25,py:.5,borderRadius:999,fontWeight:800,fontSize:13,color:m,border:`1px solid ${v}`,backgroundImage:`linear-gradient(135deg, ${x}, ${a})`,boxShadow:"0 2px 6px rgba(0,0,0,0.06) inset, 0 1px 2px rgba(0,0,0,0.04)"},children:[g&&e.jsx("span",{style:{lineHeight:1},children:g}),e.jsx("span",{children:de})]})};return e.jsxs(e.Fragment,{children:[y&&e.jsx(je,{open:A,autoHideDuration:2e3,onClose:W,children:e.jsx(Se,{onClose:W,severity:y.severity,sx:{width:"100%"},children:y.msg})},y.msg),e.jsx(i,{mb:3,children:e.jsxs(k,{title:e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(n,{variant:"h5",textTransform:"capitalize",children:[p.replace("_"," ")," perception analysis"]}),e.jsxs(n,{variant:"body2",color:"textSecondary",children:["Last update: ",re," (Colombia Time)"]})]}),children:[e.jsx(fe,{searchTerm:u,onSearchChange:ne,onClearSearch:ae,placeholder:`Search in ${p} employees...`}),e.jsx(ve,{sx:{mt:2},children:e.jsxs(Ce,{"aria-label":"filtered table",sx:{whiteSpace:"nowrap"},children:[e.jsx(we,{children:e.jsxs(J,{children:[e.jsx(f,{children:"No."}),e.jsx(f,{children:"Full Name"}),e.jsx(f,{children:"Customer"}),e.jsx(f,{children:"Perception"}),e.jsx(f,{children:"Analysis Result"}),e.jsx(f,{children:"Predictive analysis"})]})}),e.jsx(Ae,{children:V.map((t,s)=>e.jsxs(J,{children:[e.jsx(f,{children:s+1}),e.jsx(f,{children:t.fullName}),e.jsx(f,{children:t.customer}),e.jsx(f,{children:t.calification}),e.jsx(f,{children:t.clasification}),e.jsx(f,{children:e.jsx(K,{size:"small",variant:"contained",onClick:()=>ie(t),sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Show Risk"})})]},t.id))})]})})]})}),e.jsx(ue,{open:ee,onClose:P,maxWidth:"md",fullWidth:!0,children:l&&e.jsxs(e.Fragment,{children:[e.jsx(ge,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:e.jsxs(i,{sx:{display:"flex",alignItems:{xs:"start",sm:"center"},justifyContent:"space-between",gap:2,flexDirection:{xs:"column",sm:"row"}},children:[e.jsxs(i,{children:[e.jsx(n,{variant:"h6",sx:{fontWeight:800,letterSpacing:.3},children:"ATTENTION: ATTRITION RISK INSIGHTS"}),e.jsxs(n,{variant:"subtitle2",sx:{opacity:.9},children:[l.fullName,l.customer?` - ${l.customer}`:""]})]}),e.jsx(me,{label:l.clasification,color:l.clasification.toLowerCase().includes("high")?"error":l.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{fontWeight:700}})]})}),e.jsxs(be,{dividers:!0,children:[e.jsxs(i,{sx:{display:"flex",gap:2,mb:2,flexDirection:{xs:"column",md:"row"}},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsx(n,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Employee Overview"}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(n,{sx:{fontSize:"2rem"},children:"ðŸ¢"}),e.jsx(i,{children:e.jsxs(n,{variant:"body1",fontWeight:800,children:["Company: ",l.customer]})})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(n,{sx:{fontSize:"2rem"},children:l.calification==="Positive"?"ðŸ˜€":l.calification==="Negative"?"ðŸ˜ž":l.calification==="Neutral"?"ðŸ˜":"ðŸ¤¨"}),e.jsxs(i,{sx:{flex:1},children:[e.jsxs(n,{variant:"body1",fontWeight:800,gutterBottom:!0,children:["Sentiment Analysis: ",l.calification||"No comments to analyze"]}),U.length>0&&e.jsx(i,{children:U.map((t,s)=>e.jsx(n,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:t},s))})]})]})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(n,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Key Insights"}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(n,{sx:{fontSize:"2rem"},children:"ðŸ“ˆ"}),e.jsxs(i,{children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1.25,mb:.5,flexWrap:"wrap"},children:[e.jsx(n,{variant:"body1",fontWeight:800,sx:{m:0},children:"Compensation Level:"}),ce(te)]}),e.jsx(n,{variant:"body2",sx:{color:"text.secondary"},children:"Based on current local market benchmark data"})]})]}),r&&$.length>0&&e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(n,{sx:{fontSize:"2rem"},children:l.clasification.toLowerCase().includes("high")?"âŒ":l.clasification.toLowerCase().includes("medium")?"âš ï¸":l.clasification.toLowerCase().includes("low")?"âœ…":"âšª"}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(n,{variant:"body1",fontWeight:800,gutterBottom:!0,children:"Prioritized Risk Drivers"}),$.map((t,s)=>e.jsxs(n,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:["â€¢ ",t]},s))]})]})]})]}),r&&M.length>0&&e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(n,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“"}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(n,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:M.map((t,s)=>e.jsx("li",{children:t},s))})]})]}),r&&(I||T)?e.jsxs(i,{children:[I&&e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(n,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ› ï¸"}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(n,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(i,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:B.sanitize(I)}})]})]}),T&&e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(n,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ¤"}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(n,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(i,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:B.sanitize(T)}})]})]})]}):r&&q.length>0&&e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(n,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“Š"}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(n,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:q.map((t,s)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:B.sanitize(t)}},s))})]})]}),!r&&e.jsx(n,{children:"No analysis available."})]}),e.jsx(ye,{children:e.jsx(K,{onClick:P,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{ot as default};
