import{r as m,i as pe,j as e}from"./index-CJU5MQjK.js";import{B as w,C as ue}from"./BaseCard-C-iVU7C9.js";import{c as Q}from"./config-BwmyTBcy.js";import{I as ge}from"./search-CR5KhMAX.js";import{a as je}from"./dayjs.min-Db8i2R4f.js";import{x as g}from"./xlsx.min-ejKjkcee.js";import{D as be,a as ye,b as Ce,p as R,c as Se}from"./purify.es-DvjEMyp2.js";import{T as i,B as r}from"./Box-n9iJj8RL.js";import{S as ve,A as we}from"./Snackbar-CfH3m9VF.js";import{T as V}from"./TableContainer-BqdrQOUD.js";import{T as X,a as Z,b as k,c as d,d as ee}from"./TableRow-DOiG_nc3.js";import{B}from"./Button-BIdsfCL6.js";import"./Card-Ct6aUZJP.js";import"./Paper-DuLtMsh8.js";import"./createSvgIcon-Cr6Zc33o.js";import"./useForkRef-B6FfdXhL.js";import"./ButtonBase-CejpV3EC.js";import"./Divider-CQ3OK35Z.js";import"./CardContent-Dv7cKb8W.js";import"./TextField-BpfY5uKK.js";import"./useSlot-xazagwgq.js";import"./resolveComponentProps-DPIZlf2G.js";import"./useId-DE-kZWW2.js";import"./useFormControl-DUBBWsnW.js";import"./isHostComponent-DzRytwJ7.js";import"./FormControl-CoKhAxmx.js";import"./isMuiElement-DjPusY45.js";import"./Menu-Bof1kA2Y.js";import"./mergeSlotProps-BP1cH13_.js";import"./createChainedFunction-BO_9K8Jh.js";import"./useControlled-BYV30LQr.js";import"./InputAdornment-FpvjlzrZ.js";import"./IconButton-B5dw_sXu.js";import"./CircularProgress-CjQlrGo0.js";import"./Close-BhbCqjDF.js";const ot=()=>{const[j,te]=m.useState([]),[f,A]=m.useState([]),[se,z]=m.useState(!0),[p,F]=m.useState(""),[E,N]=m.useState([]),[b,ie]=m.useState(null),[_,W]=m.useState(!1),O=pe(),[re,P]=m.useState(!1),[c,H]=m.useState(null),[ne,$]=m.useState(null),oe=je().subtract(1,"day").set("hour",17).set("minute",0).format("MMMM DD, YYYY, hh:mm A"),le=t=>{H(t),P(!0),$(null);try{const s=sessionStorage.getItem("token");if(!s)return I();const h=new Headers;h.append("authToken",s),h.append("Content-Type","application/json");const a={method:"POST",headers:h,body:JSON.stringify({id:t.id}),redirect:"follow"};fetch(`${Q.rutaApi}employees_profile`,a).then(o=>o.status===401?I():o.json()).then(o=>{const l=o==null?void 0:o.dataEmployee;if(l){const x=l.salary_level??l.salaryLevel??null;$(x)}}).catch(o=>{console.error("Error fetching employee profile:",o)})}catch(s){console.error(s)}},U=()=>{P(!1),H(null)};m.useEffect(()=>{if(!_&&E.length>0){const[t,...s]=E;ie(t),N(s),W(!0)}},[E,_]),m.useEffect(()=>{const t=sessionStorage.getItem("token");if(!t){y("Token defeated, enter again","error"),z(!1),O("/auth/login");return}const s=new Headers;s.append("authToken",t);const h={method:"GET",headers:s,redirect:"follow"};y("Show Analitics Attrition","success"),fetch(`${Q.rutaApi}show_metrics_analytics_attrition`,h).then(a=>a.status===401?I():a.json()).then(a=>{if(!a||!Array.isArray(a))throw new Error("Invalid response format");const o=a.map(l=>({id:l.fkid_employe,fullName:l.full_name||"",customer:l.customer||"",calification:(()=>{try{const x=typeof l.calification=="string"?JSON.parse(l.calification.replace(/'/g,'"')):l.calification;return(x==null?void 0:x.Nivel)||""}catch{return""}})(),clasification:l.clasification||"",attrition_probability:l.attrition_probability||"",text_ai:l.text_ai||""}));te(o),A(o)}).catch(a=>{a.message!=="Unauthorized"&&(y(a.message||"Error in process","error"),console.error(a))}).finally(()=>{z(!1)})},[]);const y=(t,s)=>{N(h=>[...h,{msg:t,severity:s}])},ae=()=>{const t=f.map(o=>({"Full Name":o.fullName,Customer:o.customer,Perception:o.calification,"Analysis Result":o.clasification,"Attrition Probability":o.attrition_probability})),s=g.utils.json_to_sheet(t);Object.keys(t[0]).forEach((o,l)=>{const x=g.utils.encode_cell({r:0,c:l});s[x]&&(s[x].s={fill:{fgColor:{rgb:"D9EDE3"}},font:{color:{rgb:"222222"},bold:!1},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}})});const a=g.utils.book_new();g.utils.book_append_sheet(a,s,"Predictive Analysis"),g.writeFile(a,"report_predictive_analysis.xlsx",{bookType:"xlsx"})},M=(t,s)=>{s!=="clickaway"&&W(!1)},I=()=>{throw y("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),O("/auth/login"),new Error("Unauthorized")};m.useEffect(()=>{if(p==="")A(j);else{const t=j.filter(s=>s.fullName.toLowerCase().includes(p.toLowerCase())||s.customer.toLowerCase().includes(p.toLowerCase()));A(t)}},[p,j]);const ce=t=>{F(t)},de=()=>{F("")};if(se)return e.jsx(w,{title:"Loading...",children:e.jsx(i,{children:"Show data..."})});if(j.length===0)return e.jsx(w,{title:"No data found",children:e.jsx(i,{children:"No data available for analysis."})});const L={low:f.filter(t=>t.clasification.toLowerCase().includes("low")).length,medium:f.filter(t=>t.clasification.toLowerCase().includes("medium")).length,high:f.filter(t=>t.clasification.toLowerCase().includes("high")).length},he=t=>{var s,h,a,o,l,x;return t?{brief:(((s=t.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:s[1])||"").trim(),riskLevel:(((h=t.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:h[1])||"").trim(),drivers:(((a=t.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:a[1])||"").trim(),sentiment:(((o=t.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:o[1])||"").trim(),assessment:(((l=t.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:l[1])||"").trim(),actions:xe((((x=t.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:x[1])||"").trim())}:{}},xe=t=>{if(!t)return"";let s=String(t);const h=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return s=s.replace(h,(a,o)=>`<b>${o.trim()}:</b> `),s.trim()},C=t=>t?t.split(/\n|\. /).map(s=>s.replace(/\*\*|^-|\d+$/g,"").trim()).filter(s=>s.length>0).map(s=>s.endsWith(".")?s:s+"."):[],Y=(t,s)=>{if(!t)return"";const h=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=new RegExp(`<b>\\s*${h}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),o=t.match(a);return o?o[1].trim():""},n=c!=null&&c.text_ai?he(c.text_ai):null,q=n!=null&&n.drivers?C(n.drivers):[],G=n!=null&&n.sentiment?C(n.sentiment):[],J=n!=null&&n.assessment?C(n.assessment):[],K=n!=null&&n.actions?C(n.actions):[],T=n!=null&&n.actions?Y(n.actions,"Controllable by Us"):"",D=n!=null&&n.actions?Y(n.actions,"Controllable by the Client"):"",me=t=>{const s=(t||"").toLowerCase(),h=/low|below/.test(s),a=/compet/i.test(s),o=/high|above/.test(s);let l="#ECEFF1",x="#E5E9EC",S="#455A64",v="#CFD8DC",fe=t||"N/A",u="";return h?(l="#FDE7E9",x="#FAD1D5",S="#7A0A1A",v="#F5B7BF",u="â¬‡ï¸"):a?(l="#FFF7E0",x="#FFE8B0",S="#8A5B00",v="#FFD777",u="âš–ï¸"):o&&(l="#E6F4EA",x="#D1EFE0",S="#0D4B3B",v="#B7E1C9",u="â¬†ï¸"),e.jsxs(r,{component:"span",sx:{display:"inline-flex",alignItems:"center",gap:1,px:1.25,py:.5,borderRadius:999,fontWeight:800,fontSize:13,color:S,border:`1px solid ${v}`,backgroundImage:`linear-gradient(135deg, ${l}, ${x})`,boxShadow:"0 2px 6px rgba(0,0,0,0.06) inset, 0 1px 2px rgba(0,0,0,0.04)"},children:[u&&e.jsx("span",{style:{lineHeight:1},children:u}),e.jsx("span",{children:fe})]})};return e.jsxs(e.Fragment,{children:[b&&e.jsx(ve,{open:_,autoHideDuration:2e3,onClose:M,children:e.jsx(we,{onClose:M,severity:b.severity,sx:{width:"100%"},children:b.msg})},b.msg),e.jsx(r,{mb:3,children:e.jsx(w,{title:e.jsxs(r,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(i,{variant:"h5",children:"Overview of the analysis prediction"}),e.jsx(B,{variant:"contained",color:"success",size:"small",onClick:ae,sx:{ml:2,minWidth:140},children:"Download Excel"})]}),children:e.jsx(V,{children:e.jsxs(X,{"aria-label":"risk counts",sx:{whiteSpace:"nowrap"},children:[e.jsx(Z,{children:e.jsxs(k,{children:[e.jsx(d,{children:e.jsx(i,{variant:"subtitle1",children:"Low Risks"})}),e.jsx(d,{children:e.jsx(i,{variant:"subtitle1",children:"Medium Risks"})}),e.jsx(d,{children:e.jsx(i,{variant:"subtitle1",children:"High Risks"})})]})}),e.jsx(ee,{children:e.jsxs(k,{children:[e.jsx(d,{children:e.jsx(i,{fontWeight:600,color:"success.main",children:L.low})}),e.jsx(d,{children:e.jsx(i,{fontWeight:600,color:"warning.main",children:L.medium})}),e.jsx(d,{children:e.jsx(i,{fontWeight:600,color:"error.main",children:L.high})})]})})]})})})}),e.jsx(r,{mb:3,children:e.jsx(w,{title:e.jsxs(r,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:2},children:[e.jsxs(r,{children:[e.jsx(i,{variant:"h5",children:"Predictive Attrition Analysis"}),e.jsxs(i,{variant:"body2",color:"textSecondary",sx:{fontStyle:"italic"},children:["Last update: ",oe," (Colombia Time)"]})]}),e.jsx(ge,{searchTerm:p,onSearchChange:ce,onClearSearch:de,placeholder:"Analyzing ....",width:{xs:"100%",sm:300,md:400}})]}),children:e.jsx(V,{children:e.jsxs(X,{"aria-label":"main table",sx:{whiteSpace:"nowrap"},children:[e.jsx(Z,{children:e.jsxs(k,{children:[e.jsx(d,{children:"No."}),e.jsx(d,{children:"Full Name"}),e.jsx(d,{children:"Customer"}),e.jsx(d,{children:"Perception"}),e.jsx(d,{children:"Analysis result"}),e.jsx(d,{children:"Predictive analysis"})]})}),e.jsx(ee,{children:f.map((t,s)=>e.jsxs(k,{children:[e.jsx(d,{children:s+1}),e.jsx(d,{children:t.fullName}),e.jsx(d,{children:t.customer}),e.jsx(d,{children:t.calification}),e.jsx(d,{children:t.clasification}),e.jsx(d,{children:e.jsx(B,{size:"small",variant:"contained",sx:{mt:1,backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},onClick:()=>le(t),children:"Show Risk"})})]},t.id))})]})})})}),e.jsx(be,{open:re,onClose:U,maxWidth:"md",fullWidth:!0,children:c&&e.jsxs(e.Fragment,{children:[e.jsx(ye,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:e.jsxs(r,{sx:{display:"flex",alignItems:{xs:"start",sm:"center"},justifyContent:"space-between",gap:2,flexDirection:{xs:"column",sm:"row"}},children:[e.jsxs(r,{children:[e.jsx(i,{variant:"h6",sx:{fontWeight:800,letterSpacing:.3},children:"ATTENTION: ATTRITION RISK INSIGHTS"}),e.jsxs(i,{variant:"subtitle2",sx:{opacity:.9},children:[c.fullName,c.customer?` - ${c.customer}`:""]})]}),e.jsx(ue,{label:c.clasification,color:c.clasification.toLowerCase().includes("high")?"error":c.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{fontWeight:700}})]})}),e.jsxs(Ce,{dividers:!0,children:[e.jsxs(r,{sx:{display:"flex",gap:2,mb:2,flexDirection:{xs:"column",md:"row"}},children:[e.jsxs(r,{sx:{flex:1},children:[e.jsx(i,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Employee Overview"}),e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(i,{sx:{fontSize:"2rem"},children:"ðŸ¢"}),e.jsx(r,{children:e.jsxs(i,{variant:"body1",fontWeight:800,children:["Company: ",c.customer]})})]}),e.jsxs(r,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(i,{sx:{fontSize:"2rem"},children:c.calification==="Positive"?"ðŸ˜€":c.calification==="Negative"?"ðŸ˜ž":c.calification==="Neutral"?"ðŸ˜":"ðŸ¤¨"}),e.jsxs(r,{sx:{flex:1},children:[e.jsxs(i,{variant:"body1",fontWeight:800,gutterBottom:!0,children:["Sentiment Analysis: ",c.calification||"No comments to analyze"]}),G.length>0&&e.jsx(r,{children:G.map((t,s)=>e.jsx(i,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:t},s))})]})]})]}),e.jsxs(r,{sx:{flex:1},children:[e.jsx(i,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Key Insights"}),e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(i,{sx:{fontSize:"2rem"},children:"ðŸ“ˆ"}),e.jsxs(r,{children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:1.25,mb:.5,flexWrap:"wrap"},children:[e.jsx(i,{variant:"body1",fontWeight:800,sx:{m:0},children:"Compensation Level:"}),me(ne)]}),e.jsx(i,{variant:"body2",sx:{color:"text.secondary"},children:"Based on current local market benchmark data"})]})]}),n&&q.length>0&&e.jsxs(r,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(i,{sx:{fontSize:"2rem"},children:c.clasification.toLowerCase().includes("high")?"âŒ":c.clasification.toLowerCase().includes("medium")?"âš ï¸":c.clasification.toLowerCase().includes("low")?"âœ…":"âšª"}),e.jsxs(r,{sx:{flex:1},children:[e.jsx(i,{variant:"body1",fontWeight:800,gutterBottom:!0,children:"Prioritized Risk Drivers"}),q.map((t,s)=>e.jsxs(i,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:["â€¢ ",t]},s))]})]})]})]}),n&&J.length>0&&e.jsxs(r,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(i,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“"}),e.jsxs(r,{sx:{flex:1},children:[e.jsx(i,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:J.map((t,s)=>e.jsx("li",{children:t},s))})]})]}),n&&(T||D)?e.jsxs(r,{children:[T&&e.jsxs(r,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(i,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ› ï¸"}),e.jsxs(r,{sx:{flex:1},children:[e.jsx(i,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(r,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:R.sanitize(T)}})]})]}),D&&e.jsxs(r,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(i,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ¤"}),e.jsxs(r,{sx:{flex:1},children:[e.jsx(i,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(r,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:R.sanitize(D)}})]})]})]}):n&&K.length>0&&e.jsxs(r,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(i,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“Š"}),e.jsxs(r,{sx:{flex:1},children:[e.jsx(i,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:K.map((t,s)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:R.sanitize(t)}},s))})]})]}),!n&&e.jsx(i,{children:"No analysis available."})]}),e.jsx(Se,{children:e.jsx(B,{onClick:U,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{ot as default};
