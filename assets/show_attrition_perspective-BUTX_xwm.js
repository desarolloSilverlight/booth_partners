import{r as m,i as oe,f as le,j as e}from"./index-BxHjN_14.js";import{B as A,C as ce}from"./BaseCard-CzwRYX4b.js";import{c as F}from"./config-BwmyTBcy.js";import{I as de}from"./search-3XnHnLpP.js";import{a as me}from"./dayjs.min-BhZY1nu7.js";import{D as he,a as fe,b as xe,p as I,c as ue}from"./purify.es-B7iuLviy.js";import{T as r,B as n}from"./Box-DqDrr6YK.js";import{S as pe,A as ge}from"./Snackbar-B4rG78rB.js";import{T as ye}from"./TableContainer-vzNaEPFh.js";import{T as je,a as be,b as Y,c as h,d as Se}from"./TableRow-Dg0xDZO8.js";import{B as G}from"./Button-CAtoYENC.js";import"./Card-CY2WmlRJ.js";import"./Paper-Dc6Wg0Kl.js";import"./createSvgIcon-LNInKgTq.js";import"./useForkRef-DXUt_G2j.js";import"./ButtonBase-BO-1dZ5p.js";import"./Divider-BqZB1UZj.js";import"./CardContent-BEvJwpBT.js";import"./TextField-DJypDTBQ.js";import"./useSlot-DbUxneSh.js";import"./resolveComponentProps-C1vTgv-F.js";import"./useId-cyGmOwTB.js";import"./useFormControl-Bxdzds_I.js";import"./isHostComponent-BU_upW1Y.js";import"./FormControl-DIY7E0fa.js";import"./isMuiElement-BUzYMHMY.js";import"./Menu-DoDCDiH7.js";import"./mergeSlotProps-DRwSxopQ.js";import"./createChainedFunction-BO_9K8Jh.js";import"./useControlled-Ca8til2R.js";import"./InputAdornment-rnIdla28.js";import"./IconButton-B5LDn1PY.js";import"./CircularProgress-CsGvXAUy.js";import"./Close-C7uHXrPk.js";const st=()=>{var q;const[g,J]=m.useState([]),[Q,S]=m.useState([]),[K,T]=m.useState(!0),[p,R]=m.useState(""),[v,_]=m.useState([]),[y,V]=m.useState(null),[C,z]=m.useState(!1),[X,N]=m.useState(!1),[a,B]=m.useState(null),[Z,D]=m.useState(null),P=oe(),ee=le(),x=((q=new URLSearchParams(ee.search).get("pers"))==null?void 0:q.toLowerCase())||"all",te=me().subtract(1,"day").set("hour",17).set("minute",0).format("MMMM DD, YYYY, hh:mm A"),ie=t=>{B(t),N(!0),D(null);try{const i=sessionStorage.getItem("token");if(!i)return w();const d=new Headers;d.append("authToken",i),d.append("Content-Type","application/json");const o={method:"POST",headers:d,body:JSON.stringify({id:t.id}),redirect:"follow"};fetch(`${F.rutaApi}employees_profile`,o).then(l=>l.status===401?w():l.json()).then(l=>{const f=l==null?void 0:l.dataEmployee;if(f){const c=f.salary_level??f.salaryLevel??null;D(c)}}).catch(l=>{console.error("Error fetching employee profile:",l)})}catch(i){console.error(i)}},E=()=>{N(!1),B(null)},j=(t,i)=>{_(d=>[...d,{msg:t,severity:i}])},w=()=>{throw j("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),P("/auth/login"),new Error("Unauthorized")};m.useEffect(()=>{if(!C&&v.length>0){const[t,...i]=v;V(t),_(i),z(!0)}},[v,C]),m.useEffect(()=>{const t=sessionStorage.getItem("token");if(!t){j("Token defeated, enter again","error"),T(!1),P("/auth/login");return}const i=new Headers;i.append("authToken",t);const d={method:"GET",headers:i,redirect:"follow"};j("Loading data...","info"),fetch(`${F.rutaApi}show_metrics_analytics_attrition`,d).then(o=>o.status===401?w():o.json()).then(o=>{if(!o||!Array.isArray(o))throw new Error("Invalid response format");const f=o.map(c=>({id:c.fkid_employe,fullName:c.full_name||"",customer:c.customer||"",calification:(()=>{try{const u=typeof c.calification=="string"?JSON.parse(c.calification.replace(/'/g,'"')):c.calification;return(u==null?void 0:u.Nivel)||""}catch{return""}})(),clasification:c.clasification||"",attrition_probability:c.attrition_probability||"",text_ai:c.text_ai||""})).filter(c=>{const u=c.calification.toLowerCase();return x==="positive"?u==="positive":x==="negative"?u==="negative":x==="neutral"?u==="neutral":x==="no_comment"?c.calification==="No comments to analyze":!0});J(f),S(f)}).catch(o=>{o.message!=="Unauthorized"&&(j(o.message||"Error loading data","error"),console.error(o))}).finally(()=>{T(!1)})},[x]),m.useEffect(()=>{if(p==="")S(g);else{const t=g.filter(i=>i.fullName.toLowerCase().includes(p.toLowerCase())||i.customer.toLowerCase().includes(p.toLowerCase()));S(t)}},[p,g]);const O=(t,i)=>{i!=="clickaway"&&z(!1)},se=t=>R(t),re=()=>R("");if(K)return e.jsx(A,{title:"Loading...",children:e.jsx(r,{children:"Loading attrition data..."})});if(g.length===0)return e.jsx(A,{title:"No data found",children:e.jsx(r,{children:"No data available for this perception."})});const ne=t=>{var i,d,o,l,f,c;return t?{brief:(((i=t.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:i[1])||"").trim(),riskLevel:(((d=t.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:d[1])||"").trim(),drivers:(((o=t.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:o[1])||"").trim(),sentiment:(((l=t.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:l[1])||"").trim(),assessment:(((f=t.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:f[1])||"").trim(),actions:ae((((c=t.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:c[1])||"").trim())}:{}},ae=t=>{if(!t)return"";let i=String(t);const d=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return i=i.replace(d,(o,l)=>`<b>${l.trim()}:</b> `),i.trim()},b=t=>t?t.split(/\n|\. /).map(i=>i.replace(/\*\*|^-|\d+$/g,"").trim()).filter(i=>i.length>0).map(i=>i.endsWith(".")?i:i+"."):[],H=(t,i)=>{if(!t)return"";const d=i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(`<b>\\s*${d}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),l=t.match(o);return l?l[1].trim():""},s=a!=null&&a.text_ai?ne(a.text_ai):null,W=s!=null&&s.drivers?b(s.drivers):[],U=s!=null&&s.sentiment?b(s.sentiment):[],$=s!=null&&s.assessment?b(s.assessment):[],M=s!=null&&s.actions?b(s.actions):[],L=s!=null&&s.actions?H(s.actions,"Controllable by Us"):"",k=s!=null&&s.actions?H(s.actions,"Controllable by the Client"):"";return e.jsxs(e.Fragment,{children:[y&&e.jsx(pe,{open:C,autoHideDuration:2e3,onClose:O,children:e.jsx(ge,{onClose:O,severity:y.severity,sx:{width:"100%"},children:y.msg})},y.msg),e.jsx(n,{mb:3,children:e.jsxs(A,{title:e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(r,{variant:"h5",textTransform:"capitalize",children:[x.replace("_"," ")," perception analysis"]}),e.jsxs(r,{variant:"body2",color:"textSecondary",children:["Last update: ",te," (Colombia Time)"]})]}),children:[e.jsx(de,{searchTerm:p,onSearchChange:se,onClearSearch:re,placeholder:`Search in ${x} employees...`}),e.jsx(ye,{sx:{mt:2},children:e.jsxs(je,{"aria-label":"filtered table",sx:{whiteSpace:"nowrap"},children:[e.jsx(be,{children:e.jsxs(Y,{children:[e.jsx(h,{children:"No."}),e.jsx(h,{children:"Full Name"}),e.jsx(h,{children:"Customer"}),e.jsx(h,{children:"Perception"}),e.jsx(h,{children:"Analysis Result"}),e.jsx(h,{children:"Predictive analysis"})]})}),e.jsx(Se,{children:Q.map((t,i)=>e.jsxs(Y,{children:[e.jsx(h,{children:i+1}),e.jsx(h,{children:t.fullName}),e.jsx(h,{children:t.customer}),e.jsx(h,{children:t.calification}),e.jsx(h,{children:t.clasification}),e.jsx(h,{children:e.jsx(G,{size:"small",variant:"contained",onClick:()=>ie(t),sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Show Risk"})})]},t.id))})]})})]})}),e.jsx(he,{open:X,onClose:E,maxWidth:"md",fullWidth:!0,children:a&&e.jsxs(e.Fragment,{children:[e.jsxs(fe,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:["ATTRITION RISK INSIGHTS - ",a.fullName,e.jsx(ce,{label:a.clasification,color:a.clasification.toLowerCase().includes("high")?"error":a.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{ml:2}})]}),e.jsxs(xe,{dividers:!0,children:[e.jsx(r,{variant:"h6",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),e.jsxs(n,{sx:{display:"flex",gap:2,mb:2},children:[e.jsxs(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:2,bgcolor:"grey.100",borderRadius:2,flex:1,minWidth:100},children:[e.jsx(r,{sx:{fontSize:"2rem",mb:1},children:"🏢"}),e.jsx(r,{variant:"body1",fontWeight:"bold",align:"center",children:a.customer}),e.jsxs(n,{sx:{mt:3,display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(r,{sx:{fontSize:"2rem",mb:1},children:"💲"}),e.jsx(r,{variant:"body1",fontWeight:"bold",align:"center",children:Z??"N/A"})]})]}),e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:a.calification==="Positive"?"😀":a.calification==="Negative"?"😞":a.calification==="Neutral"?"😐":"🤨"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:a.calification==="Positive"?"Positive":a.calification==="Negative"?"Negative":a.calification==="Neutral"?"Neutral":"No comments to analyze"}),U.length>0&&e.jsx(n,{children:U.map((t,i)=>e.jsx(r,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:t},i))})]})]}),s&&W.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2,minWidth:280},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:a.clasification.toLowerCase().includes("high")?"❌":a.clasification.toLowerCase().includes("medium")?"⚠️":a.clasification.toLowerCase().includes("low")?"✅":"⚪"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),W.map((t,i)=>e.jsxs(r,{variant:"body2",sx:{color:"text.secondary",mb:1},children:["• ",t]},i))]})]})]}),s&&$.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"📝"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:$.map((t,i)=>e.jsx("li",{children:t},i))})]})]}),s&&(L||k)?e.jsxs(n,{children:[L&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"🛠️"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:I.sanitize(L)}})]})]}),k&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"🤝"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:I.sanitize(k)}})]})]})]}):s&&M.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"📊"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:M.map((t,i)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:I.sanitize(t)}},i))})]})]}),!s&&e.jsx(r,{children:"No analysis available."})]}),e.jsx(ue,{children:e.jsx(G,{onClick:E,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{st as default};
