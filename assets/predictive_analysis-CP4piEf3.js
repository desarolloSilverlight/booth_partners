import{r as m,i as de,j as e}from"./index-BxHjN_14.js";import{B as C,C as he}from"./BaseCard-CzwRYX4b.js";import{c as G}from"./config-BwmyTBcy.js";import{I as me}from"./search-3XnHnLpP.js";import{a as xe}from"./dayjs.min-BhZY1nu7.js";import{x as p}from"./xlsx.min-BostqdXq.js";import{D as fe,a as ue,b as pe,p as T,c as ge}from"./purify.es-B7iuLviy.js";import{T as s,B as l}from"./Box-DqDrr6YK.js";import{S as je,A as be}from"./Snackbar-B4rG78rB.js";import{T as J}from"./TableContainer-vzNaEPFh.js";import{T as Q,a as K,b as S,c as d,d as V}from"./TableRow-Dg0xDZO8.js";import{B as R}from"./Button-CAtoYENC.js";import"./Card-CY2WmlRJ.js";import"./Paper-Dc6Wg0Kl.js";import"./createSvgIcon-LNInKgTq.js";import"./useForkRef-DXUt_G2j.js";import"./ButtonBase-BO-1dZ5p.js";import"./Divider-BqZB1UZj.js";import"./CardContent-BEvJwpBT.js";import"./TextField-DJypDTBQ.js";import"./useSlot-DbUxneSh.js";import"./resolveComponentProps-C1vTgv-F.js";import"./useId-cyGmOwTB.js";import"./useFormControl-Bxdzds_I.js";import"./isHostComponent-BU_upW1Y.js";import"./FormControl-DIY7E0fa.js";import"./isMuiElement-BUzYMHMY.js";import"./Menu-DoDCDiH7.js";import"./mergeSlotProps-DRwSxopQ.js";import"./createChainedFunction-BO_9K8Jh.js";import"./useControlled-Ca8til2R.js";import"./InputAdornment-rnIdla28.js";import"./IconButton-B5LDn1PY.js";import"./CircularProgress-CsGvXAUy.js";import"./Close-C7uHXrPk.js";const tt=()=>{const[g,X]=m.useState([]),[f,v]=m.useState([]),[Z,z]=m.useState(!0),[u,D]=m.useState(""),[w,N]=m.useState([]),[j,ee]=m.useState(null),[k,B]=m.useState(!1),E=de(),[te,P]=m.useState(!1),[a,W]=m.useState(null),[ie,O]=m.useState(null),se=xe().subtract(1,"day").set("hour",17).set("minute",0).format("MMMM DD, YYYY, hh:mm A"),re=t=>{W(t),P(!0),O(null);try{const i=sessionStorage.getItem("token");if(!i)return _();const h=new Headers;h.append("authToken",i),h.append("Content-Type","application/json");const o={method:"POST",headers:h,body:JSON.stringify({id:t.id}),redirect:"follow"};fetch(`${G.rutaApi}employees_profile`,o).then(n=>n.status===401?_():n.json()).then(n=>{const c=n==null?void 0:n.dataEmployee;if(c){const x=c.salary_level??c.salaryLevel??null;O(x)}}).catch(n=>{console.error("Error fetching employee profile:",n)})}catch(i){console.error(i)}},H=()=>{P(!1),W(null)};m.useEffect(()=>{if(!k&&w.length>0){const[t,...i]=w;ee(t),N(i),B(!0)}},[w,k]),m.useEffect(()=>{const t=sessionStorage.getItem("token");if(!t){b("Token defeated, enter again","error"),z(!1),E("/auth/login");return}const i=new Headers;i.append("authToken",t);const h={method:"GET",headers:i,redirect:"follow"};b("Show Analitics Attrition","success"),fetch(`${G.rutaApi}show_metrics_analytics_attrition`,h).then(o=>o.status===401?_():o.json()).then(o=>{if(!o||!Array.isArray(o))throw new Error("Invalid response format");const n=o.map(c=>({id:c.fkid_employe,fullName:c.full_name||"",customer:c.customer||"",calification:(()=>{try{const x=typeof c.calification=="string"?JSON.parse(c.calification.replace(/'/g,'"')):c.calification;return(x==null?void 0:x.Nivel)||""}catch{return""}})(),clasification:c.clasification||"",attrition_probability:c.attrition_probability||"",text_ai:c.text_ai||""}));X(n),v(n)}).catch(o=>{o.message!=="Unauthorized"&&(b(o.message||"Error in process","error"),console.error(o))}).finally(()=>{z(!1)})},[]);const b=(t,i)=>{N(h=>[...h,{msg:t,severity:i}])},ne=()=>{const t=f.map(n=>({"Full Name":n.fullName,Customer:n.customer,Perception:n.calification,"Analysis Result":n.clasification,"Attrition Probability":n.attrition_probability})),i=p.utils.json_to_sheet(t);Object.keys(t[0]).forEach((n,c)=>{const x=p.utils.encode_cell({r:0,c});i[x]&&(i[x].s={fill:{fgColor:{rgb:"D9EDE3"}},font:{color:{rgb:"222222"},bold:!1},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}})});const o=p.utils.book_new();p.utils.book_append_sheet(o,i,"Predictive Analysis"),p.writeFile(o,"report_predictive_analysis.xlsx",{bookType:"xlsx"})},U=(t,i)=>{i!=="clickaway"&&B(!1)},_=()=>{throw b("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),E("/auth/login"),new Error("Unauthorized")};m.useEffect(()=>{if(u==="")v(g);else{const t=g.filter(i=>i.fullName.toLowerCase().includes(u.toLowerCase())||i.customer.toLowerCase().includes(u.toLowerCase()));v(t)}},[u,g]);const le=t=>{D(t)},oe=()=>{D("")};if(Z)return e.jsx(C,{title:"Loading...",children:e.jsx(s,{children:"Show data..."})});if(g.length===0)return e.jsx(C,{title:"No data found",children:e.jsx(s,{children:"No data available for analysis."})});const A={low:f.filter(t=>t.clasification.toLowerCase().includes("low")).length,medium:f.filter(t=>t.clasification.toLowerCase().includes("medium")).length,high:f.filter(t=>t.clasification.toLowerCase().includes("high")).length},ae=t=>{var i,h,o,n,c,x;return t?{brief:(((i=t.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:i[1])||"").trim(),riskLevel:(((h=t.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:h[1])||"").trim(),drivers:(((o=t.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:o[1])||"").trim(),sentiment:(((n=t.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:n[1])||"").trim(),assessment:(((c=t.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:c[1])||"").trim(),actions:ce((((x=t.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:x[1])||"").trim())}:{}},ce=t=>{if(!t)return"";let i=String(t);const h=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return i=i.replace(h,(o,n)=>`<b>${n.trim()}:</b> `),i.trim()},y=t=>t?t.split(/\n|\. /).map(i=>i.replace(/\*\*|^-|\d+$/g,"").trim()).filter(i=>i.length>0).map(i=>i.endsWith(".")?i:i+"."):[],M=(t,i)=>{if(!t)return"";const h=i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(`<b>\\s*${h}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),n=t.match(o);return n?n[1].trim():""},r=a!=null&&a.text_ai?ae(a.text_ai):null,$=r!=null&&r.drivers?y(r.drivers):[],F=r!=null&&r.sentiment?y(r.sentiment):[],Y=r!=null&&r.assessment?y(r.assessment):[],q=r!=null&&r.actions?y(r.actions):[],L=r!=null&&r.actions?M(r.actions,"Controllable by Us"):"",I=r!=null&&r.actions?M(r.actions,"Controllable by the Client"):"";return e.jsxs(e.Fragment,{children:[j&&e.jsx(je,{open:k,autoHideDuration:2e3,onClose:U,children:e.jsx(be,{onClose:U,severity:j.severity,sx:{width:"100%"},children:j.msg})},j.msg),e.jsx(l,{mb:3,children:e.jsx(C,{title:e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(s,{variant:"h5",children:"Overview of the analysis prediction"}),e.jsx(R,{variant:"contained",color:"success",size:"small",onClick:ne,sx:{ml:2,minWidth:140},children:"Download Excel"})]}),children:e.jsx(J,{children:e.jsxs(Q,{"aria-label":"risk counts",sx:{whiteSpace:"nowrap"},children:[e.jsx(K,{children:e.jsxs(S,{children:[e.jsx(d,{children:e.jsx(s,{variant:"subtitle1",children:"Low Risks"})}),e.jsx(d,{children:e.jsx(s,{variant:"subtitle1",children:"Medium Risks"})}),e.jsx(d,{children:e.jsx(s,{variant:"subtitle1",children:"High Risks"})})]})}),e.jsx(V,{children:e.jsxs(S,{children:[e.jsx(d,{children:e.jsx(s,{fontWeight:600,color:"success.main",children:A.low})}),e.jsx(d,{children:e.jsx(s,{fontWeight:600,color:"warning.main",children:A.medium})}),e.jsx(d,{children:e.jsx(s,{fontWeight:600,color:"error.main",children:A.high})})]})})]})})})}),e.jsx(l,{mb:3,children:e.jsx(C,{title:e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:2},children:[e.jsxs(l,{children:[e.jsx(s,{variant:"h5",children:"Predictive Attrition Analysis"}),e.jsxs(s,{variant:"body2",color:"textSecondary",sx:{fontStyle:"italic"},children:["Last update: ",se," (Colombia Time)"]})]}),e.jsx(me,{searchTerm:u,onSearchChange:le,onClearSearch:oe,placeholder:"Analyzing ....",width:{xs:"100%",sm:300,md:400}})]}),children:e.jsx(J,{children:e.jsxs(Q,{"aria-label":"main table",sx:{whiteSpace:"nowrap"},children:[e.jsx(K,{children:e.jsxs(S,{children:[e.jsx(d,{children:"No."}),e.jsx(d,{children:"Full Name"}),e.jsx(d,{children:"Customer"}),e.jsx(d,{children:"Perception"}),e.jsx(d,{children:"Analysis result"}),e.jsx(d,{children:"Predictive analysis"})]})}),e.jsx(V,{children:f.map((t,i)=>e.jsxs(S,{children:[e.jsx(d,{children:i+1}),e.jsx(d,{children:t.fullName}),e.jsx(d,{children:t.customer}),e.jsx(d,{children:t.calification}),e.jsx(d,{children:t.clasification}),e.jsx(d,{children:e.jsx(R,{size:"small",variant:"contained",sx:{mt:1,backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},onClick:()=>re(t),children:"Show Risk"})})]},t.id))})]})})})}),e.jsx(fe,{open:te,onClose:H,maxWidth:"md",fullWidth:!0,children:a&&e.jsxs(e.Fragment,{children:[e.jsxs(ue,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:["ATTRITION RISK INSIGHTS - ",a.fullName,e.jsx(he,{label:a.clasification,color:a.clasification.toLowerCase().includes("high")?"error":a.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{ml:2}})]}),e.jsxs(pe,{dividers:!0,children:[e.jsx(s,{variant:"h6",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),e.jsxs(l,{sx:{display:"flex",gap:2,mb:2},children:[e.jsxs(l,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:2,bgcolor:"grey.100",borderRadius:2,flex:1,minWidth:100},children:[e.jsx(s,{sx:{fontSize:"2rem",mb:1},children:"ðŸ¢"}),e.jsx(s,{variant:"body1",fontWeight:"bold",align:"center",children:a.customer}),e.jsxs(l,{sx:{mt:3,display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(s,{sx:{fontSize:"2rem",mb:1},children:"ðŸ’²"}),e.jsx(s,{variant:"body1",fontWeight:"bold",align:"center",children:ie??"N/A"})]})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2},children:[e.jsx(s,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:a.calification==="Positive"?"ðŸ˜€":a.calification==="Negative"?"ðŸ˜ž":a.calification==="Neutral"?"ðŸ˜":"ðŸ¤¨"}),e.jsxs(l,{sx:{flex:1},children:[e.jsx(s,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:a.calification==="Positive"?"Positive":a.calification==="Negative"?"Negative":a.calification==="Neutral"?"Neutral":"No comments to analyze"}),F.length>0&&e.jsx(l,{children:F.map((t,i)=>e.jsx(s,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:t},i))})]})]}),r&&$.length>0&&e.jsxs(l,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2,minWidth:280},children:[e.jsx(s,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:a.clasification.toLowerCase().includes("high")?"âŒ":a.clasification.toLowerCase().includes("medium")?"âš ï¸":a.clasification.toLowerCase().includes("low")?"âœ…":"âšª"}),e.jsxs(l,{sx:{flex:1},children:[e.jsx(s,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),$.map((t,i)=>e.jsxs(s,{variant:"body2",sx:{color:"text.secondary",mb:1},children:["â€¢ ",t]},i))]})]})]}),r&&Y.length>0&&e.jsxs(l,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(s,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“"}),e.jsxs(l,{sx:{flex:1},children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:Y.map((t,i)=>e.jsx("li",{children:t},i))})]})]}),r&&(L||I)?e.jsxs(l,{children:[L&&e.jsxs(l,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(s,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ› ï¸"}),e.jsxs(l,{sx:{flex:1},children:[e.jsx(s,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(l,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:T.sanitize(L)}})]})]}),I&&e.jsxs(l,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(s,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ¤"}),e.jsxs(l,{sx:{flex:1},children:[e.jsx(s,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(l,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:T.sanitize(I)}})]})]})]}):r&&q.length>0&&e.jsxs(l,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(s,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“Š"}),e.jsxs(l,{sx:{flex:1},children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:q.map((t,i)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:T.sanitize(t)}},i))})]})]}),!r&&e.jsx(s,{children:"No analysis available."})]}),e.jsx(ge,{children:e.jsx(R,{onClick:H,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{tt as default};
