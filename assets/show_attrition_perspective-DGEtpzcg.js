import{r as c,i as re,f as ne,j as e}from"./index-a8kbXjkM.js";import{B as k,C as ae}from"./BaseCard-CaVKqiGQ.js";import{c as oe}from"./config-BwmyTBcy.js";import{I as le}from"./search-Dj58SK4A.js";import{a as ce}from"./dayjs.min-8vVxtEmQ.js";import{D as de,a as me,b as he,p as A,c as xe}from"./purify.es-CHLVRN25.js";import{T as r,B as n}from"./Box-BxUS-AKn.js";import{S as fe,A as ue}from"./Snackbar-CIgrxjIL.js";import{T as pe}from"./TableContainer-sb6WmyXz.js";import{T as ge,a as je,b as M,c as d,d as be}from"./TableRow-Bje9yeSC.js";import{B as F}from"./Button-BKx_4WKL.js";import"./Card-BPtRDKI0.js";import"./Paper-D-RdRHSj.js";import"./createSvgIcon-kD1ZWZUU.js";import"./useForkRef-Dx36i4TJ.js";import"./ButtonBase-CdWBoicg.js";import"./Divider-BqRgsaQ7.js";import"./CardContent-ClSNjI8-.js";import"./TextField-BMV7h-2U.js";import"./useSlot-Dz5mhnmg.js";import"./resolveComponentProps-Bn6s_OOL.js";import"./useId-BmV5-Wjm.js";import"./useFormControl-DWTlw4CR.js";import"./isHostComponent-BePQffoO.js";import"./FormControl-BnFS-8lD.js";import"./isMuiElement-mFh1iwH4.js";import"./Menu-CEMCVjjb.js";import"./mergeSlotProps-CNS-LPbI.js";import"./createChainedFunction-BO_9K8Jh.js";import"./useControlled-DtlPQB9n.js";import"./InputAdornment-CAss5QvY.js";import"./IconButton-CsDBEJf6.js";import"./CircularProgress-BH9toPbs.js";import"./Close-BMRxtogn.js";const tt=()=>{var $;const[g,Y]=c.useState([]),[q,S]=c.useState([]),[G,I]=c.useState(!0),[p,R]=c.useState(""),[v,T]=c.useState([]),[j,Q]=c.useState(null),[C,_]=c.useState(!1),[J,z]=c.useState(!1),[a,B]=c.useState(null),N=re(),K=ne(),x=(($=new URLSearchParams(K.search).get("pers"))==null?void 0:$.toLowerCase())||"all",V=ce().subtract(1,"day").set("hour",17).set("minute",0).format("MMMM DD, YYYY, hh:mm A"),X=t=>{B(t),z(!0)},D=()=>{z(!1),B(null)},b=(t,i)=>{T(m=>[...m,{msg:t,severity:i}])},Z=()=>{throw b("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),N("/auth/login"),new Error("Unauthorized")};c.useEffect(()=>{if(!C&&v.length>0){const[t,...i]=v;Q(t),T(i),_(!0)}},[v,C]),c.useEffect(()=>{const t=sessionStorage.getItem("token");if(!t){b("Token defeated, enter again","error"),I(!1),N("/auth/login");return}const i=new Headers;i.append("authToken",t);const m={method:"GET",headers:i,redirect:"follow"};b("Loading data...","info"),fetch(`${oe.rutaApi}show_metrics_analytics_attrition`,m).then(o=>o.status===401?Z():o.json()).then(o=>{if(!o||!Array.isArray(o))throw new Error("Invalid response format");const u=o.map(l=>({id:l.fkid_employe,fullName:l.full_name||"",customer:l.customer||"",calification:(()=>{try{const f=typeof l.calification=="string"?JSON.parse(l.calification.replace(/'/g,'"')):l.calification;return(f==null?void 0:f.Nivel)||""}catch{return""}})(),clasification:l.clasification||"",attrition_probability:l.attrition_probability||"",text_ai:l.text_ai||""})).filter(l=>{const f=l.calification.toLowerCase();return x==="positive"?f==="positive":x==="negative"?f==="negative":x==="neutral"?f==="neutral":x==="no_comment"?l.calification==="No comments to analyze":!0});Y(u),S(u)}).catch(o=>{o.message!=="Unauthorized"&&(b(o.message||"Error loading data","error"),console.error(o))}).finally(()=>{I(!1)})},[x]),c.useEffect(()=>{if(p==="")S(g);else{const t=g.filter(i=>i.fullName.toLowerCase().includes(p.toLowerCase())||i.customer.toLowerCase().includes(p.toLowerCase()));S(t)}},[p,g]);const P=(t,i)=>{i!=="clickaway"&&_(!1)},ee=t=>R(t),te=()=>R("");if(G)return e.jsx(k,{title:"Loading...",children:e.jsx(r,{children:"Loading attrition data..."})});if(g.length===0)return e.jsx(k,{title:"No data found",children:e.jsx(r,{children:"No data available for this perception."})});const ie=t=>{var i,m,o,h,u,l;return t?{brief:(((i=t.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:i[1])||"").trim(),riskLevel:(((m=t.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:m[1])||"").trim(),drivers:(((o=t.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:o[1])||"").trim(),sentiment:(((h=t.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:h[1])||"").trim(),assessment:(((u=t.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:u[1])||"").trim(),actions:se((((l=t.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:l[1])||"").trim())}:{}},se=t=>{if(!t)return"";let i=String(t);const m=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return i=i.replace(m,(o,h)=>`<b>${h.trim()}:</b> `),i.trim()},y=t=>t?t.split(/\n|\. /).map(i=>i.replace(/\*\*|^-|\d+$/g,"").trim()).filter(i=>i.length>0).map(i=>i.endsWith(".")?i:i+"."):[],O=(t,i)=>{if(!t)return"";const m=i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(`<b>\\s*${m}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),h=t.match(o);return h?h[1].trim():""},s=a!=null&&a.text_ai?ie(a.text_ai):null,W=s!=null&&s.drivers?y(s.drivers):[],E=s!=null&&s.sentiment?y(s.sentiment):[],H=s!=null&&s.assessment?y(s.assessment):[],U=s!=null&&s.actions?y(s.actions):[],w=s!=null&&s.actions?O(s.actions,"Controllable by Us"):"",L=s!=null&&s.actions?O(s.actions,"Controllable by the Client"):"";return e.jsxs(e.Fragment,{children:[j&&e.jsx(fe,{open:C,autoHideDuration:2e3,onClose:P,children:e.jsx(ue,{onClose:P,severity:j.severity,sx:{width:"100%"},children:j.msg})},j.msg),e.jsx(n,{mb:3,children:e.jsxs(k,{title:e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(r,{variant:"h5",textTransform:"capitalize",children:[x.replace("_"," ")," perception analysis"]}),e.jsxs(r,{variant:"body2",color:"textSecondary",children:["Last update: ",V," (Colombia Time)"]})]}),children:[e.jsx(le,{searchTerm:p,onSearchChange:ee,onClearSearch:te,placeholder:`Search in ${x} employees...`}),e.jsx(pe,{sx:{mt:2},children:e.jsxs(ge,{"aria-label":"filtered table",sx:{whiteSpace:"nowrap"},children:[e.jsx(je,{children:e.jsxs(M,{children:[e.jsx(d,{children:"No."}),e.jsx(d,{children:"Full Name"}),e.jsx(d,{children:"Customer"}),e.jsx(d,{children:"Perception"}),e.jsx(d,{children:"Analysis Result"}),e.jsx(d,{children:"Predictive analysis"})]})}),e.jsx(be,{children:q.map((t,i)=>e.jsxs(M,{children:[e.jsx(d,{children:i+1}),e.jsx(d,{children:t.fullName}),e.jsx(d,{children:t.customer}),e.jsx(d,{children:t.calification}),e.jsx(d,{children:t.clasification}),e.jsx(d,{children:e.jsx(F,{size:"small",variant:"contained",onClick:()=>X(t),sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Show Risk"})})]},t.id))})]})})]})}),e.jsx(de,{open:J,onClose:D,maxWidth:"md",fullWidth:!0,children:a&&e.jsxs(e.Fragment,{children:[e.jsxs(me,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:["ATTRITION RISK INSIGHTS - ",a.fullName,e.jsx(ae,{label:a.clasification,color:a.clasification.toLowerCase().includes("high")?"error":a.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{ml:2}})]}),e.jsxs(he,{dividers:!0,children:[e.jsx(r,{variant:"h6",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),e.jsxs(n,{sx:{display:"flex",gap:2,mb:2},children:[e.jsxs(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:2,bgcolor:"grey.100",borderRadius:2,flex:1,minWidth:100},children:[e.jsx(r,{sx:{fontSize:"2rem",mb:1},children:"ðŸ¢"}),e.jsx(r,{variant:"body1",fontWeight:"bold",align:"center",children:a.customer})]}),e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:a.calification==="Positive"?"ðŸ˜€":a.calification==="Negative"?"ðŸ˜ž":a.calification==="Neutral"?"ðŸ˜":"ðŸ¤¨"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:a.calification==="Positive"?"Positive":a.calification==="Negative"?"Negative":a.calification==="Neutral"?"Neutral":"No comments to analyze"}),E.length>0&&e.jsx(n,{children:E.map((t,i)=>e.jsx(r,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:t},i))})]})]}),s&&W.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2,minWidth:280},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:a.clasification.toLowerCase().includes("high")?"âŒ":a.clasification.toLowerCase().includes("medium")?"âš ï¸":a.clasification.toLowerCase().includes("low")?"âœ…":"âšª"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),W.map((t,i)=>e.jsxs(r,{variant:"body2",sx:{color:"text.secondary",mb:1},children:["â€¢ ",t]},i))]})]})]}),s&&H.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:H.map((t,i)=>e.jsx("li",{children:t},i))})]})]}),s&&(w||L)?e.jsxs(n,{children:[w&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ› ï¸"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:A.sanitize(w)}})]})]}),L&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ¤"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:A.sanitize(L)}})]})]})]}):s&&U.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“Š"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:U.map((t,i)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:A.sanitize(t)}},i))})]})]}),!s&&e.jsx(r,{children:"No analysis available."})]}),e.jsx(xe,{children:e.jsx(F,{onClick:D,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{tt as default};
