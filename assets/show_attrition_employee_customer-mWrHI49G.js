import{r as d,f as xe,i as fe,j as e}from"./index-BxHjN_14.js";import{B as S,C as ue}from"./BaseCard-CzwRYX4b.js";import{I as pe}from"./search-3XnHnLpP.js";import{c as V}from"./config-BwmyTBcy.js";import{x as g}from"./xlsx.min-BostqdXq.js";import{D as ge,a as je,b as ye,p as I,c as be}from"./purify.es-B7iuLviy.js";import{T as n,B as o}from"./Box-DqDrr6YK.js";import{S as Ce,A as Se}from"./Snackbar-B4rG78rB.js";import{T as X}from"./TableContainer-vzNaEPFh.js";import{T as Y,a as Z,b as v,c as a,d as ee}from"./TableRow-Dg0xDZO8.js";import{B as N}from"./Button-CAtoYENC.js";import"./Card-CY2WmlRJ.js";import"./Paper-Dc6Wg0Kl.js";import"./createSvgIcon-LNInKgTq.js";import"./useForkRef-DXUt_G2j.js";import"./ButtonBase-BO-1dZ5p.js";import"./Divider-BqZB1UZj.js";import"./CardContent-BEvJwpBT.js";import"./TextField-DJypDTBQ.js";import"./useSlot-DbUxneSh.js";import"./resolveComponentProps-C1vTgv-F.js";import"./useId-cyGmOwTB.js";import"./useFormControl-Bxdzds_I.js";import"./isHostComponent-BU_upW1Y.js";import"./FormControl-DIY7E0fa.js";import"./isMuiElement-BUzYMHMY.js";import"./Menu-DoDCDiH7.js";import"./mergeSlotProps-DRwSxopQ.js";import"./createChainedFunction-BO_9K8Jh.js";import"./useControlled-Ca8til2R.js";import"./InputAdornment-rnIdla28.js";import"./IconButton-B5LDn1PY.js";import"./CircularProgress-CsGvXAUy.js";import"./Close-C7uHXrPk.js";const st=()=>{const[j,te]=d.useState([]),[u,w]=d.useState([]),ie=xe(),[y,z]=d.useState(""),B=new URLSearchParams(ie.search),D=fe(),[k,E]=d.useState([]),[p,P]=d.useState(null),[se,O]=d.useState(!0),[re,W]=d.useState(!1),[ne,H]=d.useState(!1),[l,U]=d.useState(null),[oe,$]=d.useState(null),le=B.get("cliente"),ae=B.get("riesgo");d.useEffect(()=>{const t=sessionStorage.getItem("token");if(!t){b("Token defeated, enter again","error"),O(!1),D("/auth/login");return}const i=new Headers;i.append("authToken",t),i.append("Content-Type","application/json");const h={method:"POST",headers:i,body:JSON.stringify({cliente:le,riesgo:ae}),redirect:"follow"};b("Risk per client","success"),fetch(`${V.rutaApi}show_attrition_employee_customer`,h).then(s=>s.status===401?_():s.json()).then(s=>{if(s.error)throw new Error(s.error);const m=s.dataAttrition||s;if(!Array.isArray(m))throw new Error("Invalid response format");const x=m.map(f=>({id:f.fkid_employe,fullName:f.full_name||"",customer:f.customer||"",calification:(()=>{try{const T=typeof f.calification=="string"?JSON.parse(f.calification.replace(/'/g,'"')):f.calification;return(T==null?void 0:T.Nivel)||""}catch{return""}})(),clasification:f.clasification||"",attrition_probability:f.attrition_probability||"",text_ai:f.text_ai||""}));te(x),w(x)}).catch(s=>{s.message!=="Unauthorized"&&(b(s.message||"Error in process","error"),console.error(s))}).finally(()=>O(!1))},[]);const b=(t,i)=>{E(c=>[...c,{msg:t,severity:i}])};d.useEffect(()=>{if(y==="")w(j);else{const t=j.filter(i=>i.fullName.toLowerCase().includes(y.toLowerCase()));w(t)}},[y,j]),d.useEffect(()=>{if(!p&&k.length>0){const t=k[0];P(t),E(i=>i.slice(1)),W(!0)}},[k,p]);const ce=()=>{const t=u.map(s=>({"Full Name":s.fullName,Customer:s.customer,Perception:s.calification,"Analysis Result":s.clasification,"Attrition Probability":s.attrition_probability})),i=g.utils.json_to_sheet(t);Object.keys(t[0]).forEach((s,m)=>{const x=g.utils.encode_cell({r:0,c:m});i[x]&&(i[x].s={fill:{fgColor:{rgb:"B8CCE4"}},font:{color:{rgb:"222222"},bold:!1},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}})});const h=g.utils.book_new();g.utils.book_append_sheet(h,i,"Predictive Analysis"),g.writeFile(h,"report_risk_per_customer.xlsx",{bookType:"xlsx"})},F=(t,i)=>{i!=="clickaway"&&(W(!1),P(null))},_=()=>{throw b("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),D("/auth/login"),new Error("Unauthorized")},de=t=>{U(t),H(!0),$(null);try{const i=sessionStorage.getItem("token");if(!i)return _();const c=new Headers;c.append("authToken",i),c.append("Content-Type","application/json");const h={method:"POST",headers:c,body:JSON.stringify({id:t.id}),redirect:"follow"};fetch(`${V.rutaApi}employees_profile`,h).then(s=>s.status===401?_():s.json()).then(s=>{const m=s==null?void 0:s.dataEmployee;if(m){const x=m.salary_level??m.salaryLevel??null;$(x)}}).catch(s=>{console.error("Error fetching employee profile:",s)})}catch(i){console.error(i)}},M=()=>{H(!1),U(null)},A={low:u.filter(t=>t.clasification.toLowerCase().includes("low")).length,medium:u.filter(t=>t.clasification.toLowerCase().includes("medium")).length,high:u.filter(t=>t.clasification.toLowerCase().includes("high")).length},he=t=>{var i,c,h,s,m,x;return t?{brief:(((i=t.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:i[1])||"").trim(),riskLevel:(((c=t.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:c[1])||"").trim(),drivers:(((h=t.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:h[1])||"").trim(),sentiment:(((s=t.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:s[1])||"").trim(),assessment:(((m=t.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:m[1])||"").trim(),actions:me((((x=t.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:x[1])||"").trim())}:{}},me=t=>{if(!t)return"";let i=String(t);const c=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return i=i.replace(c,(h,s)=>`<b>${s.trim()}:</b> `),i.trim()},C=t=>t?t.split(/\n|\. /).map(i=>i.replace(/\*\*|^-|\d+$/g,"").trim()).filter(i=>i.length>0):[],J=(t,i)=>{if(!t)return"";const c=i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),h=new RegExp(`<b>\\s*${c}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),s=t.match(h);return s?s[1].trim():""},r=l!=null&&l.text_ai?he(l.text_ai):null,q=r!=null&&r.drivers?C(r.drivers):[],Q=r!=null&&r.sentiment?C(r.sentiment):[],G=r!=null&&r.assessment?C(r.assessment):[],K=r!=null&&r.actions?C(r.actions):[],R=r!=null&&r.actions?J(r.actions,"Controllable by Us"):"",L=r!=null&&r.actions?J(r.actions,"Controllable by the Client"):"";return se?e.jsx(S,{title:"Loading...",children:e.jsx(n,{children:"Show data..."})}):j.length===0?e.jsx(S,{title:"No data found",children:e.jsx(n,{children:"No data available for analysis."})}):e.jsxs(e.Fragment,{children:[p&&e.jsx(Ce,{open:re,autoHideDuration:2e3,onClose:F,children:e.jsx(Se,{onClose:F,severity:p.severity,sx:{width:"100%"},children:p.msg})}),e.jsx(o,{mb:3,children:e.jsx(S,{title:"Overview of the analysis prediction",children:e.jsx(X,{children:e.jsxs(Y,{children:[e.jsx(Z,{children:e.jsxs(v,{children:[e.jsx(a,{children:e.jsx(n,{variant:"subtitle1",children:"Low Risks"})}),e.jsx(a,{children:e.jsx(n,{variant:"subtitle1",children:"Medium Risks"})}),e.jsx(a,{children:e.jsx(n,{variant:"subtitle1",children:"High Risks"})})]})}),e.jsx(ee,{children:e.jsxs(v,{children:[e.jsx(a,{children:e.jsx(n,{fontWeight:600,color:"success.main",children:A.low})}),e.jsx(a,{children:e.jsx(n,{fontWeight:600,color:"warning.main",children:A.medium})}),e.jsx(a,{children:e.jsx(n,{fontWeight:600,color:"error.main",children:A.high})})]})})]})})})}),e.jsx(S,{title:e.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:2},children:[e.jsx(n,{variant:"h5",children:"Predictive Attrition Analysis"}),e.jsx(o,{sx:{flex:1,display:"flex",justifyContent:"center"},children:e.jsx(pe,{searchTerm:y,onSearchChange:z,onClearSearch:()=>z(""),placeholder:"Search employee...",width:{xs:"100%",sm:300,md:400}})}),e.jsx(N,{variant:"contained",color:"success",size:"small",onClick:ce,sx:{minWidth:140},children:"Download Excel"})]}),children:e.jsx(X,{children:e.jsxs(Y,{children:[e.jsx(Z,{children:e.jsxs(v,{children:[e.jsx(a,{children:"No."}),e.jsx(a,{children:"Full Name"}),e.jsx(a,{children:"Customer"}),e.jsx(a,{children:"Perception"}),e.jsx(a,{children:"Analysis result"}),e.jsx(a,{children:"Predictive analysis"})]})}),e.jsx(ee,{children:u.map((t,i)=>e.jsxs(v,{children:[e.jsx(a,{children:i+1}),e.jsx(a,{children:t.fullName}),e.jsx(a,{children:t.customer}),e.jsx(a,{children:t.calification}),e.jsx(a,{children:t.clasification}),e.jsx(a,{children:e.jsx(N,{size:"small",variant:"contained",onClick:()=>de(t),sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Show Risk"})})]},t.id))})]})})}),e.jsx(ge,{open:ne,onClose:M,maxWidth:"md",fullWidth:!0,children:l&&e.jsxs(e.Fragment,{children:[e.jsxs(je,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:["ATTRITION RISK INSIGHTS - ",l.fullName,e.jsx(ue,{label:l.clasification,color:l.clasification.toLowerCase().includes("high")?"error":l.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{ml:2}})]}),e.jsxs(ye,{dividers:!0,children:[e.jsx(n,{variant:"h6",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),e.jsxs(o,{sx:{display:"flex",gap:2,mb:2},children:[e.jsxs(o,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:2,bgcolor:"grey.100",borderRadius:2,flex:1,minWidth:100},children:[e.jsx(n,{sx:{fontSize:"2rem",mb:1},children:"ðŸ¢"}),e.jsx(n,{variant:"body1",fontWeight:"bold",align:"center",children:l.customer}),e.jsxs(o,{sx:{mt:3,display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(n,{sx:{fontSize:"2rem",mb:1},children:"ðŸ’²"}),e.jsx(n,{variant:"body1",fontWeight:"bold",align:"center",children:oe??"N/A"})]})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2},children:[e.jsx(n,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:l.calification==="Positive"?"ðŸ˜€":l.calification==="Negative"?"ðŸ˜ž":l.calification==="Neutral"?"ðŸ˜":"ðŸ¤¨"}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(n,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:l.calification==="Positive"?"Positive":l.calification==="Negative"?"Negative":l.calification==="Neutral"?"Neutral":"No comments to analyze"}),Q.length>0&&e.jsx(o,{children:Q.map((t,i)=>e.jsx(n,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:t},i))})]})]}),r&&q.length>0&&e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2,minWidth:280},children:[e.jsx(n,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:l.clasification.toLowerCase().includes("high")?"âŒ":l.clasification.toLowerCase().includes("medium")?"âš ï¸":l.clasification.toLowerCase().includes("low")?"âœ…":"âšª"}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(n,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),q.map((t,i)=>e.jsxs(n,{variant:"body2",sx:{color:"text.secondary",mb:1},children:["â€¢ ",t]},i))]})]})]}),r&&G.length>0&&e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(n,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“"}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(n,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:G.map((t,i)=>e.jsx("li",{children:t},i))})]})]}),r&&(R||L)?e.jsxs(o,{children:[R&&e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(n,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ› ï¸"}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(n,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(o,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:I.sanitize(R)}})]})]}),L&&e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(n,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ¤"}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(n,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(o,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:I.sanitize(L)}})]})]})]}):r&&K.length>0&&e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(n,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“Š"}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(n,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:K.map((t,i)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:I.sanitize(t)}},i))})]})]}),!r&&e.jsx(n,{children:"No analysis available."})]}),e.jsx(be,{children:e.jsx(N,{onClick:M,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{st as default};
