import{r as h,f as Q,i as ce,j as e}from"./index-B9c6G4RU.js";import{B as de,C as me}from"./BaseCard-B7xEBDih.js";import{I as xe}from"./search-Cu_u-BJp.js";import{c as Z}from"./config-DOW8WNQj.js";import{x as y}from"./xlsx.min-BOxVq-EU.js";import{p as I}from"./purify.es-DxJI3Wx7.js";import{S as he}from"./Snackbar-BW2920sI.js";import{A as fe}from"./Alert-D64dzqcI.js";import{T as pe,a as ue,b as ge,c as G,d as f,e as be}from"./TableRow-owgTIb2d.js";import{B as R}from"./Button-C_RbK71c.js";import{B as n,T as l}from"./Box-DY5rMG6q.js";import{D as ye,a as je,b as Ce,c as Se}from"./DialogTitle-C3bzlF34.js";import"./Card-DY8qMz7M.js";import"./Paper-Djww9Kda.js";import"./createSvgIcon-CuCLOW51.js";import"./useForkRef-bxOkU-Fv.js";import"./ButtonBase-DaiUm-zC.js";import"./Divider-CID0eBmV.js";import"./CardContent-B0TW8JlS.js";import"./TextField-BzY1DWUU.js";import"./useSlot--7nv0rPO.js";import"./resolveComponentProps-lSV5xpUt.js";import"./useId--VlEiZJx.js";import"./useFormControl-iTPikZFj.js";import"./isHostComponent-kiJGbep4.js";import"./FormControl-FjhdrhiG.js";import"./isMuiElement-DYmjoWWl.js";import"./Modal-sn2O3BuZ.js";import"./ownerDocument-DW-IO8s5.js";import"./createChainedFunction-BO_9K8Jh.js";import"./Menu-Dm3AkTow.js";import"./mergeSlotProps-CeBRw_gE.js";import"./useControlled-knxWmPfA.js";import"./InputAdornment-BIIeC6kB.js";import"./IconButton-Xr0163ay.js";import"./CircularProgress-16haAPjs.js";import"./Close-CwlFG3CA.js";const lt=()=>{const[S,T]=h.useState([]),[_,j]=h.useState([]);Q();const[u,B]=h.useState(""),L=ce(),X=new URLSearchParams(Q().search),[w,z]=h.useState([]),[g,N]=h.useState(null),[we,V]=h.useState(!0),[Y,D]=h.useState(!1),[ee,F]=h.useState(!1),[x,O]=h.useState(null),[te,W]=h.useState(null),$=X.get("risk");h.useEffect(()=>{const s=sessionStorage.getItem("token");if(!s){alert("Token defeated, enter again"),L("/auth/login");return}const t=new Headers;t.append("authToken",s),t.append("Content-Type","application/json");const a={method:"POST",headers:t,body:JSON.stringify({risk:$}),redirect:"follow"};C(`Show All Risks In ${$}`,"success"),fetch(`${Z.rutaApi}show_risks`,a).then(r=>r.status===401?v():r.json()).then(r=>{if(r.error)throw new Error(r.error);if(r.message){C(r.message,"info"),j([]),T([]);return}const o=r.dataRisks||r;if(!Array.isArray(o))throw new Error("Invalid data format received from server");const c=o.map(d=>({id:d.fkid_employe||d.id||0,fullName:d.full_name||"N/A",customer:d.customer||"N/A",calification:(()=>{try{const p=typeof d.calification=="string"?JSON.parse(d.calification.replace(/'/g,'"')):d.calification;return(p==null?void 0:p.Nivel)||""}catch{return""}})(),clasification:d.clasification||"N/A",attrition_probability:d.attrition_probability||"N/A",text_ai:d.text_ai||"No additional info"}));T(c),j(c)}).catch(r=>{r.message!=="Unauthorized"&&(C(r.message||"Error in process","error"),console.error(r))}).finally(()=>V(!1))},[]);const C=(s,t)=>{z(m=>[...m,{msg:s,severity:t}])};h.useEffect(()=>{if(u==="")j(S);else{const s=S.filter(t=>t.fullName.toLowerCase().includes(u.toLowerCase())||t.customer.toLowerCase().includes(u.toLowerCase()));j(s)}},[u,S]),h.useEffect(()=>{if(!g&&w.length>0){const s=w[0];N(s),z(t=>t.slice(1)),D(!0)}},[w,g]);const se=()=>{const s=_.map(r=>({"Full Name":r.fullName,Customer:r.customer,Perception:r.calification,"Analysis Result":r.clasification,"Attrition Probability":r.attrition_probability})),t=y.utils.json_to_sheet(s);Object.keys(s[0]).forEach((r,o)=>{const c=y.utils.encode_cell({r:0,c:o});t[c]&&(t[c].s={fill:{fgColor:{rgb:"B8CCE4"}},font:{color:{rgb:"222222"},bold:!1},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}})});const a=y.utils.book_new();y.utils.book_append_sheet(a,t,"Predictive Analysis"),y.writeFile(a,"report_per_risk.xlsx",{bookType:"xlsx"})},P=(s,t)=>{t!=="clickaway"&&(D(!1),N(null))},v=()=>{throw C("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),L("/auth/login"),new Error("Unauthorized")},re=s=>{O(s),F(!0),W(null);try{const t=sessionStorage.getItem("token");if(!t)return v();const m=new Headers;m.append("authToken",t),m.append("Content-Type","application/json");const a={method:"POST",headers:m,body:JSON.stringify({id:s.id}),redirect:"follow"};fetch(`${Z.rutaApi}employees_profile`,a).then(r=>r.status===401?v():r.json()).then(r=>{const o=r==null?void 0:r.dataEmployee,c=Array.isArray(o)?o[0]:o;if(c){const d=c.salary_level??c.salaryLevel??null;W(d)}}).catch(r=>{console.error("Error fetching employee profile:",r)})}catch(t){console.error(t)}},H=()=>{F(!1),O(null)},ie=s=>{var t,m,a,r,o,c;return s?{brief:(((t=s.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:t[1])||"").trim(),riskLevel:(((m=s.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:m[1])||"").trim(),drivers:(((a=s.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:a[1])||"").trim(),sentiment:(((r=s.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:r[1])||"").trim(),assessment:(((o=s.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:o[1])||"").trim(),actions:ne((((c=s.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:c[1])||"").trim())}:{}},ne=s=>{if(!s)return"";let t=String(s);const m=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return t=t.replace(m,(a,r)=>`<b>${r.trim()}:</b> `),t.trim()},A=s=>s?s.split(/\n|\. /).map(t=>t.replace(/\*\*|^-|\d+$/g,"").trim()).filter(t=>t.length>0).map(t=>t.endsWith(".")?t:t+"."):[],oe=s=>{if(!s)return[];const t=s.replace(/\r\n?/g,`
`).split(`
`).map(o=>o.trim()),m=[];let a="";const r=o=>/^(â€¢|\-|\*)\s+/.test(o)||/^(\d+\.|\([a-zA-Z]\))\s+/.test(o);for(const o of t){const c=o.trim();if(c)if(r(c)){if(a){const d=a.replace(/\s+/g," ").trim();m.push(/\.[\)\]]?$/.test(d)?d:d+".")}a=c.replace(/^((â€¢|\-|\*|\d+\.|\([a-zA-Z]\))\s+)/,"")}else if(a){const d=/[\w\)]$/.test(a);a+=(d?" ":"")+c}else a=c}if(a){const o=a.replace(/\s+/g," ").trim();m.push(/\.[\)\]]?$/.test(o)?o:o+".")}return m},U=(s,t)=>{if(!s)return"";const m=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=new RegExp(`<b>\\s*${m}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),r=s.match(a);return r?r[1].trim():""},i=x!=null&&x.text_ai?ie(x.text_ai):null,J=i!=null&&i.drivers?oe(i.drivers):[],M=i!=null&&i.sentiment?A(i.sentiment):[],q=i!=null&&i.assessment?A(i.assessment):[],K=i!=null&&i.actions?A(i.actions):[],k=i!=null&&i.actions?U(i.actions,"Controllable by Us"):"",E=i!=null&&i.actions?U(i.actions,"Controllable by the Client"):"",le=s=>{const t=(s||"").toLowerCase(),m=/low|below/.test(t),a=/compet/i.test(t),r=/high|above/.test(t);let o="#ECEFF1",c="#E5E9EC",d="#455A64",p="#CFD8DC",ae=s||"N/A",b="";return m?(o="#FDE7E9",c="#FAD1D5",d="#7A0A1A",p="#F5B7BF",b="â¬‡ï¸"):a?(o="#FFF7E0",c="#FFE8B0",d="#8A5B00",p="#FFD777",b="âš–ï¸"):r&&(o="#E6F4EA",c="#D1EFE0",d="#0D4B3B",p="#B7E1C9",b="â¬†ï¸"),e.jsxs(n,{component:"span",sx:{display:"inline-flex",alignItems:"center",gap:1,px:1.25,py:.5,borderRadius:999,fontWeight:800,fontSize:13,color:d,border:`1px solid ${p}`,backgroundImage:`linear-gradient(135deg, ${o}, ${c})`,boxShadow:"0 2px 6px rgba(0,0,0,0.06) inset, 0 1px 2px rgba(0,0,0,0.04)"},children:[b&&e.jsx("span",{style:{lineHeight:1},children:b}),e.jsx("span",{children:ae})]})};return e.jsxs(e.Fragment,{children:[g&&e.jsx(he,{open:Y,autoHideDuration:2e3,onClose:P,children:e.jsx(fe,{onClose:P,severity:g.severity,sx:{width:"100%"},children:g.msg})}),e.jsx(de,{title:e.jsxs(n,{sx:{display:"flex",alignItems:"center",width:"100%",gap:{xs:2,sm:4},flexDirection:{xs:"column",sm:"row"},justifyContent:"space-between"},children:[e.jsx(l,{variant:"h5",children:"Show Risks"}),e.jsx(n,{sx:{flex:1,display:"flex",justifyContent:"center"},children:e.jsx(xe,{searchTerm:u,onSearchChange:B,onClearSearch:()=>B(""),placeholder:"Search by Name or Customer",width:250})}),e.jsx(R,{variant:"contained",color:"success",size:"small",onClick:se,sx:{minWidth:140},children:"Download Excel"})]}),children:e.jsx(pe,{sx:{width:"100%",overflowX:"auto"},children:e.jsxs(ue,{"aria-label":"simple table",sx:{whiteSpace:"nowrap"},children:[e.jsx(ge,{children:e.jsxs(G,{children:[e.jsx(f,{children:"No."}),e.jsx(f,{children:"Full Name"}),e.jsx(f,{children:"Customer"}),e.jsx(f,{children:"Perception"}),e.jsx(f,{children:"Analysis Result"}),e.jsx(f,{children:"Predictive Analysis"})]})}),e.jsx(be,{children:_.map((s,t)=>e.jsxs(G,{children:[e.jsx(f,{children:t+1}),e.jsx(f,{children:s.fullName}),e.jsx(f,{children:s.customer}),e.jsx(f,{children:s.calification}),e.jsx(f,{children:s.clasification}),e.jsx(f,{children:e.jsx(R,{size:"small",variant:"contained",sx:{mt:1,backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},onClick:()=>re(s),children:"Show Text"})})]},s.id))})]})})}),e.jsx(ye,{open:ee,onClose:H,maxWidth:"md",fullWidth:!0,children:x&&e.jsxs(e.Fragment,{children:[e.jsx(je,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:e.jsxs(n,{sx:{display:"flex",alignItems:{xs:"start",sm:"center"},justifyContent:"space-between",gap:2,flexDirection:{xs:"column",sm:"row"}},children:[e.jsxs(n,{children:[e.jsx(l,{variant:"h6",sx:{fontWeight:800,letterSpacing:.3},children:"ATTENTION: ATTRITION RISK INSIGHTS"}),e.jsxs(l,{variant:"subtitle2",sx:{opacity:.9},children:[x.fullName,x.customer?` - ${x.customer}`:""]})]}),e.jsx(me,{label:x.clasification,color:x.clasification.toLowerCase().includes("high")?"error":x.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{fontWeight:700}})]})}),e.jsxs(Ce,{dividers:!0,children:[e.jsxs(n,{sx:{display:"flex",gap:2,mb:2,flexDirection:{xs:"column",md:"row"}},children:[e.jsxs(n,{sx:{flex:1},children:[e.jsx(l,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Employee Overview"}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(l,{sx:{fontSize:"2rem"},children:"ðŸ¢"}),e.jsx(n,{children:e.jsxs(l,{variant:"body1",fontWeight:800,children:["Company: ",x.customer]})})]}),e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(l,{sx:{fontSize:"2rem"},children:x.calification==="Positive"?"ðŸ˜€":x.calification==="Negative"?"ðŸ˜ž":x.calification==="Neutral"?"ðŸ˜":"ðŸ¤¨"}),e.jsxs(n,{sx:{flex:1},children:[e.jsxs(l,{variant:"body1",fontWeight:800,gutterBottom:!0,children:["Sentiment Analysis: ",x.calification||"No comments to analyze"]}),M.length>0&&e.jsx(n,{children:M.map((s,t)=>e.jsx(l,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:s},t))})]})]})]}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(l,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Key Insights"}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(l,{sx:{fontSize:"2rem"},children:"ðŸ“ˆ"}),e.jsxs(n,{children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.25,mb:.5,flexWrap:"wrap"},children:[e.jsx(l,{variant:"body1",fontWeight:800,sx:{m:0},children:"Compensation Level:"}),le(te)]}),e.jsx(l,{variant:"body2",sx:{color:"text.secondary"},children:"Based on current local market benchmark data"})]})]}),i&&J.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(l,{sx:{fontSize:"2rem"},children:x.clasification.toLowerCase().includes("high")?"âŒ":x.clasification.toLowerCase().includes("medium")?"âš ï¸":x.clasification.toLowerCase().includes("low")?"âœ…":"âšª"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(l,{variant:"body1",fontWeight:800,gutterBottom:!0,children:"Prioritized Risk Drivers"}),J.map((s,t)=>e.jsxs(l,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:["â€¢ ",s]},t))]})]})]})]}),i&&q.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(l,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:q.map((s,t)=>e.jsx("li",{children:s},t))})]})]}),i&&(k||E)?e.jsxs(n,{children:[k&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(l,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ› ï¸"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:I.sanitize(k)}})]})]}),E&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(l,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ¤"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:I.sanitize(E)}})]})]})]}):i&&K.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(l,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“Š"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:K.map((s,t)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:I.sanitize(s)}},t))})]})]}),!i&&e.jsx(l,{children:"No analysis available."})]}),e.jsx(Se,{children:e.jsx(R,{onClick:H,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{lt as default};
