import{r as f,f as ge,i as je,j as e}from"./index-BI0Y4PNa.js";import{B as w,C as be}from"./BaseCard-D2wjChVe.js";import{I as ye}from"./search-CVU9AK0l.js";import{c as V}from"./config-DOW8WNQj.js";import{x as b}from"./xlsx.min-DUkYChwO.js";import{p as B}from"./purify.es-DxJI3Wx7.js";import{T as r,B as n}from"./Box-BJAbsDBA.js";import{S as Ce}from"./Snackbar-BaKyCAh_.js";import{A as Se}from"./Alert-BpR8cUDB.js";import{T as X,a as Y,b as ee,c as v,d as m,e as te}from"./TableRow-SsAsQYgy.js";import{B as R}from"./Button-B8VGVutO.js";import{D as we,a as ve,b as Ae,c as ke}from"./DialogTitle-D1AjoEZ0.js";import"./Card-CjfQfeJx.js";import"./Paper-lRVHHjor.js";import"./createSvgIcon-sw-kBliC.js";import"./useForkRef-B4TTIjar.js";import"./ButtonBase-vmhUyOZL.js";import"./Divider-BHIR5Aop.js";import"./CardContent-B2Q3bols.js";import"./TextField-Dw7vWCpn.js";import"./useSlot-CJdQ5ZsT.js";import"./resolveComponentProps-CfG3k9Ot.js";import"./useId-ByUH1QbO.js";import"./useFormControl-Dk5vMOYt.js";import"./isHostComponent-Db4o0x6b.js";import"./FormControl-B38JvpjD.js";import"./isMuiElement-DJAIeLqF.js";import"./Modal-B90qlw3v.js";import"./ownerDocument-DW-IO8s5.js";import"./createChainedFunction-BO_9K8Jh.js";import"./Menu-CBkDRKwd.js";import"./mergeSlotProps-DGSwv7r8.js";import"./useControlled-eCEPnpab.js";import"./InputAdornment-DzCWBXaN.js";import"./IconButton-DxZcyvTB.js";import"./CircularProgress-N9GwNpy4.js";import"./Close-BXD-Rx-Y.js";const dt=()=>{const[y,se]=f.useState([]),[u,A]=f.useState([]),ie=ge(),[C,z]=f.useState(""),D=new URLSearchParams(ie.search),N=je(),[k,F]=f.useState([]),[g,O]=f.useState(null),[re,W]=f.useState(!0),[ne,P]=f.useState(!1),[oe,H]=f.useState(!1),[x,$]=f.useState(null),[le,U]=f.useState(null),ae=D.get("cliente"),ce=D.get("riesgo");f.useEffect(()=>{const t=sessionStorage.getItem("token");if(!t){S("Token defeated, enter again","error"),W(!1),N("/auth/login");return}const s=new Headers;s.append("authToken",t),s.append("Content-Type","application/json");const a={method:"POST",headers:s,body:JSON.stringify({cliente:ae,riesgo:ce}),redirect:"follow"};S("Risk per client","success"),fetch(`${V.rutaApi}show_attrition_employee_customer`,a).then(i=>i.status===401?_():i.json()).then(i=>{if(i.error)throw new Error(i.error);const l=i.dataAttrition||i;if(!Array.isArray(l))throw new Error("Invalid response format");const c=l.map(h=>({id:h.fkid_employe,fullName:h.full_name||"",customer:h.customer||"",calification:(()=>{try{const p=typeof h.calification=="string"?JSON.parse(h.calification.replace(/'/g,'"')):h.calification;return(p==null?void 0:p.Nivel)||""}catch{return""}})(),clasification:h.clasification||"",attrition_probability:h.attrition_probability||"",text_ai:h.text_ai||""}));se(c),A(c)}).catch(i=>{i.message!=="Unauthorized"&&(S(i.message||"Error in process","error"),console.error(i))}).finally(()=>W(!1))},[]);const S=(t,s)=>{F(d=>[...d,{msg:t,severity:s}])};f.useEffect(()=>{if(C==="")A(y);else{const t=y.filter(s=>s.fullName.toLowerCase().includes(C.toLowerCase()));A(t)}},[C,y]),f.useEffect(()=>{if(!g&&k.length>0){const t=k[0];O(t),F(s=>s.slice(1)),P(!0)}},[k,g]);const de=()=>{const t=u.map(i=>({"Full Name":i.fullName,Customer:i.customer,Perception:i.calification,"Analysis Result":i.clasification,"Attrition Probability":i.attrition_probability})),s=b.utils.json_to_sheet(t);Object.keys(t[0]).forEach((i,l)=>{const c=b.utils.encode_cell({r:0,c:l});s[c]&&(s[c].s={fill:{fgColor:{rgb:"B8CCE4"}},font:{color:{rgb:"222222"},bold:!1},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}})});const a=b.utils.book_new();b.utils.book_append_sheet(a,s,"Predictive Analysis"),b.writeFile(a,"report_risk_per_customer.xlsx",{bookType:"xlsx"})},M=(t,s)=>{s!=="clickaway"&&(P(!1),O(null))},_=()=>{throw S("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),N("/auth/login"),new Error("Unauthorized")},he=t=>{$(t),H(!0),U(null);try{const s=sessionStorage.getItem("token");if(!s)return _();const d=new Headers;d.append("authToken",s),d.append("Content-Type","application/json");const a={method:"POST",headers:d,body:JSON.stringify({id:t.id}),redirect:"follow"};fetch(`${V.rutaApi}employees_profile`,a).then(i=>i.status===401?_():i.json()).then(i=>{const l=i==null?void 0:i.dataEmployee;if(l){const c=l.salary_level??l.salaryLevel??null;U(c)}}).catch(i=>{console.error("Error fetching employee profile:",i)})}catch(s){console.error(s)}},J=()=>{H(!1),$(null)},E={low:u.filter(t=>t.clasification.toLowerCase().includes("low")).length,medium:u.filter(t=>t.clasification.toLowerCase().includes("medium")).length,high:u.filter(t=>t.clasification.toLowerCase().includes("high")).length},xe=t=>{var s,d,a,i,l,c;return t?{brief:(((s=t.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:s[1])||"").trim(),riskLevel:(((d=t.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:d[1])||"").trim(),drivers:(((a=t.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:a[1])||"").trim(),sentiment:(((i=t.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:i[1])||"").trim(),assessment:(((l=t.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:l[1])||"").trim(),actions:me((((c=t.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:c[1])||"").trim())}:{}},me=t=>{if(!t)return"";let s=String(t);const d=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return s=s.replace(d,(a,i)=>`<b>${i.trim()}:</b> `),s.trim()},L=t=>t?t.split(/\n|\. /).map(s=>s.replace(/\*\*|^-|\d+$/g,"").trim()).filter(s=>s.length>0).map(s=>s.endsWith(".")?s:s+"."):[],fe=t=>{if(!t)return[];const s=t.replace(/\r\n?/g,`
`).split(`
`).map(l=>l.trim()),d=[];let a="";const i=l=>/^(â€¢|\-|\*)\s+/.test(l)||/^(\d+\.|\([a-zA-Z]\))\s+/.test(l);for(const l of s){const c=l.trim();if(c)if(i(c)){if(a){const h=a.replace(/\s+/g," ").trim();d.push(/\.[\)\]]?$/.test(h)?h:h+".")}a=c.replace(/^((â€¢|\-|\*|\d+\.|\([a-zA-Z]\))\s+)/,"")}else if(a){const h=/[\w\)]$/.test(a);a+=(h?" ":"")+c}else a=c}if(a){const l=a.replace(/\s+/g," ").trim();d.push(/\.[\)\]]?$/.test(l)?l:l+".")}return d},q=(t,s)=>{if(!t)return"";const d=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=new RegExp(`<b>\\s*${d}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),i=t.match(a);return i?i[1].trim():""},o=x!=null&&x.text_ai?xe(x.text_ai):null,K=o!=null&&o.drivers?fe(o.drivers):[],Q=o!=null&&o.sentiment?L(o.sentiment):[],Z=o!=null&&o.assessment?L(o.assessment):[],G=o!=null&&o.actions?L(o.actions):[],I=o!=null&&o.actions?q(o.actions,"Controllable by Us"):"",T=o!=null&&o.actions?q(o.actions,"Controllable by the Client"):"",pe=t=>{const s=(t||"").toLowerCase(),d=/low|below/.test(s),a=/compet/i.test(s),i=/high|above/.test(s);let l="#ECEFF1",c="#E5E9EC",h="#455A64",p="#CFD8DC",ue=t||"N/A",j="";return d?(l="#FDE7E9",c="#FAD1D5",h="#7A0A1A",p="#F5B7BF",j="â¬‡ï¸"):a?(l="#FFF7E0",c="#FFE8B0",h="#8A5B00",p="#FFD777",j="âš–ï¸"):i&&(l="#E6F4EA",c="#D1EFE0",h="#0D4B3B",p="#B7E1C9",j="â¬†ï¸"),e.jsxs(n,{component:"span",sx:{display:"inline-flex",alignItems:"center",gap:1,px:1.25,py:.5,borderRadius:999,fontWeight:800,fontSize:13,color:h,border:`1px solid ${p}`,backgroundImage:`linear-gradient(135deg, ${l}, ${c})`,boxShadow:"0 2px 6px rgba(0,0,0,0.06) inset, 0 1px 2px rgba(0,0,0,0.04)"},children:[j&&e.jsx("span",{style:{lineHeight:1},children:j}),e.jsx("span",{children:ue})]})};return re?e.jsx(w,{title:"Loading...",children:e.jsx(r,{children:"Show data..."})}):y.length===0?e.jsx(w,{title:"No data found",children:e.jsx(r,{children:"No data available for analysis."})}):e.jsxs(e.Fragment,{children:[g&&e.jsx(Ce,{open:ne,autoHideDuration:2e3,onClose:M,children:e.jsx(Se,{onClose:M,severity:g.severity,sx:{width:"100%"},children:g.msg})}),e.jsx(n,{mb:3,children:e.jsx(w,{title:"Overview of the analysis prediction",children:e.jsx(X,{children:e.jsxs(Y,{children:[e.jsx(ee,{children:e.jsxs(v,{children:[e.jsx(m,{children:e.jsx(r,{variant:"subtitle1",children:"Low Risks"})}),e.jsx(m,{children:e.jsx(r,{variant:"subtitle1",children:"Medium Risks"})}),e.jsx(m,{children:e.jsx(r,{variant:"subtitle1",children:"High Risks"})})]})}),e.jsx(te,{children:e.jsxs(v,{children:[e.jsx(m,{children:e.jsx(r,{fontWeight:600,color:"success.main",children:E.low})}),e.jsx(m,{children:e.jsx(r,{fontWeight:600,color:"warning.main",children:E.medium})}),e.jsx(m,{children:e.jsx(r,{fontWeight:600,color:"error.main",children:E.high})})]})})]})})})}),e.jsx(w,{title:e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:2},children:[e.jsx(r,{variant:"h5",children:"Predictive Attrition Analysis"}),e.jsx(n,{sx:{flex:1,display:"flex",justifyContent:"center"},children:e.jsx(ye,{searchTerm:C,onSearchChange:z,onClearSearch:()=>z(""),placeholder:"Search employee...",width:{xs:"100%",sm:300,md:400}})}),e.jsx(R,{variant:"contained",color:"success",size:"small",onClick:de,sx:{minWidth:140},children:"Download Excel"})]}),children:e.jsx(X,{children:e.jsxs(Y,{children:[e.jsx(ee,{children:e.jsxs(v,{children:[e.jsx(m,{children:"No."}),e.jsx(m,{children:"Full Name"}),e.jsx(m,{children:"Customer"}),e.jsx(m,{children:"Perception"}),e.jsx(m,{children:"Analysis result"}),e.jsx(m,{children:"Predictive analysis"})]})}),e.jsx(te,{children:u.map((t,s)=>e.jsxs(v,{children:[e.jsx(m,{children:s+1}),e.jsx(m,{children:t.fullName}),e.jsx(m,{children:t.customer}),e.jsx(m,{children:t.calification}),e.jsx(m,{children:t.clasification}),e.jsx(m,{children:e.jsx(R,{size:"small",variant:"contained",onClick:()=>he(t),sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Show Risk"})})]},t.id))})]})})}),e.jsx(we,{open:oe,onClose:J,maxWidth:"md",fullWidth:!0,children:x&&e.jsxs(e.Fragment,{children:[e.jsx(ve,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:e.jsxs(n,{sx:{display:"flex",alignItems:{xs:"start",sm:"center"},justifyContent:"space-between",gap:2,flexDirection:{xs:"column",sm:"row"}},children:[e.jsxs(n,{children:[e.jsx(r,{variant:"h6",sx:{fontWeight:800,letterSpacing:.3},children:"ATTENTION: ATTRITION RISK INSIGHTS"}),e.jsxs(r,{variant:"subtitle2",sx:{opacity:.9},children:[x.fullName,x.customer?` - ${x.customer}`:""]})]}),e.jsx(be,{label:x.clasification,color:x.clasification.toLowerCase().includes("high")?"error":x.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{fontWeight:700}})]})}),e.jsxs(Ae,{dividers:!0,children:[e.jsxs(n,{sx:{display:"flex",gap:2,mb:2,flexDirection:{xs:"column",md:"row"}},children:[e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Employee Overview"}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem"},children:"ðŸ¢"}),e.jsx(n,{children:e.jsxs(r,{variant:"body1",fontWeight:800,children:["Company: ",x.customer]})})]}),e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(r,{sx:{fontSize:"2rem"},children:x.calification==="Positive"?"ðŸ˜€":x.calification==="Negative"?"ðŸ˜ž":x.calification==="Neutral"?"ðŸ˜":"ðŸ¤¨"}),e.jsxs(n,{sx:{flex:1},children:[e.jsxs(r,{variant:"body1",fontWeight:800,gutterBottom:!0,children:["Sentiment Analysis: ",x.calification||"No comments to analyze"]}),Q.length>0&&e.jsx(n,{children:Q.map((t,s)=>e.jsx(r,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:t},s))})]})]})]}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",sx:{fontWeight:800,mb:1},children:"Key Insights"}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem"},children:"ðŸ“ˆ"}),e.jsxs(n,{children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.25,mb:.5,flexWrap:"wrap"},children:[e.jsx(r,{variant:"body1",fontWeight:800,sx:{m:0},children:"Compensation Level:"}),pe(le)]}),e.jsx(r,{variant:"body2",sx:{color:"text.secondary"},children:"Based on current local market benchmark data"})]})]}),o&&K.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,boxShadow:1},children:[e.jsx(r,{sx:{fontSize:"2rem"},children:x.clasification.toLowerCase().includes("high")?"âŒ":x.clasification.toLowerCase().includes("medium")?"âš ï¸":x.clasification.toLowerCase().includes("low")?"âœ…":"âšª"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"body1",fontWeight:800,gutterBottom:!0,children:"Prioritized Risk Drivers"}),K.map((t,s)=>e.jsxs(r,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:["â€¢ ",t]},s))]})]})]})]}),o&&Z.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:Z.map((t,s)=>e.jsx("li",{children:t},s))})]})]}),o&&(I||T)?e.jsxs(n,{children:[I&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ› ï¸"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:B.sanitize(I)}})]})]}),T&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ¤"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:B.sanitize(T)}})]})]})]}):o&&G.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(r,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“Š"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:G.map((t,s)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:B.sanitize(t)}},s))})]})]}),!o&&e.jsx(r,{children:"No analysis available."})]}),e.jsx(ke,{children:e.jsx(R,{onClick:J,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{dt as default};
