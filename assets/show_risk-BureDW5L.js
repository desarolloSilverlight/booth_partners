import{r as c,f as Q,i as ne,j as e}from"./index-DArN1dFc.js";import{B as oe,C as le}from"./BaseCard-Cg43ZxhI.js";import{I as ae}from"./search-CWDMEkhZ.js";import{c as G}from"./config-BwmyTBcy.js";import{x as g}from"./xlsx.min-CQw50bkL.js";import{D as ce,a as de,b as me,p as R,c as he}from"./purify.es-_LGT0QS-.js";import{S as xe,A as fe}from"./Snackbar-DMLzH0xt.js";import{T as ue}from"./TableContainer-8mM9xP1v.js";import{T as pe,a as ge,b as K,c as h,d as be}from"./TableRow-C05IkDPC.js";import{B as _}from"./Button-DFQgupCU.js";import{B as n,T as o}from"./Box-BHYhwnxN.js";import"./Card-Du0Kn1VK.js";import"./Paper-B5KoSjAN.js";import"./createSvgIcon-D7lE_Aax.js";import"./useForkRef-X5pKffJm.js";import"./ButtonBase-Cv0cNbR4.js";import"./Divider-BLx_cDjH.js";import"./CardContent-C1faP2Cf.js";import"./TextField-mw47RwrW.js";import"./useSlot-CM4vz_9Z.js";import"./resolveComponentProps-B-_MkBH8.js";import"./useId-CaCPV4SW.js";import"./useFormControl-BG_ohv3c.js";import"./isHostComponent-u6UK2IpH.js";import"./FormControl-C0fJZd7j.js";import"./isMuiElement-2WvzZlkK.js";import"./Menu-CKCCcL5K.js";import"./mergeSlotProps-BsUbI6Zw.js";import"./createChainedFunction-BO_9K8Jh.js";import"./useControlled-CA0XlClY.js";import"./InputAdornment-9MZsHl5I.js";import"./IconButton-B30qnOO0.js";import"./CircularProgress-DBhgfc4y.js";import"./Close-fMrf0Zk0.js";const et=()=>{const[C,T]=c.useState([]),[I,b]=c.useState([]);Q();const[u,N]=c.useState(""),L=ne(),X=new URLSearchParams(Q().search),[S,z]=c.useState([]),[p,B]=c.useState(null),[ye,V]=c.useState(!0),[Y,E]=c.useState(!1),[Z,D]=c.useState(!1),[l,P]=c.useState(null),[ee,O]=c.useState(null),H=X.get("risk");c.useEffect(()=>{const t=sessionStorage.getItem("token");if(!t){alert("Token defeated, enter again"),L("/auth/login");return}const s=new Headers;s.append("authToken",t),s.append("Content-Type","application/json");const d={method:"POST",headers:s,body:JSON.stringify({risk:H}),redirect:"follow"};y(`Show All Risks In ${H}`,"success"),fetch(`${G.rutaApi}show_risks`,d).then(i=>i.status===401?v():i.json()).then(i=>{if(i.error)throw new Error(i.error);if(i.message){y(i.message,"info"),b([]),T([]);return}const m=i.dataRisks||i;if(!Array.isArray(m))throw new Error("Invalid data format received from server");const x=m.map(f=>({id:f.id||0,fullName:f.full_name||"N/A",customer:f.customer||"N/A",calification:(()=>{try{const A=typeof f.calification=="string"?JSON.parse(f.calification.replace(/'/g,'"')):f.calification;return(A==null?void 0:A.Nivel)||""}catch{return""}})(),clasification:f.clasification||"N/A",attrition_probability:f.attrition_probability||"N/A",text_ai:f.text_ai||"No additional info"}));T(x),b(x)}).catch(i=>{i.message!=="Unauthorized"&&(y(i.message||"Error in process","error"),console.error(i))}).finally(()=>V(!1))},[]);const y=(t,s)=>{z(a=>[...a,{msg:t,severity:s}])};c.useEffect(()=>{if(u==="")b(C);else{const t=C.filter(s=>s.fullName.toLowerCase().includes(u.toLowerCase())||s.customer.toLowerCase().includes(u.toLowerCase()));b(t)}},[u,C]),c.useEffect(()=>{if(!p&&S.length>0){const t=S[0];B(t),z(s=>s.slice(1)),E(!0)}},[S,p]);const te=()=>{const t=I.map(i=>({"Full Name":i.fullName,Customer:i.customer,Perception:i.calification,"Analysis Result":i.clasification,"Attrition Probability":i.attrition_probability})),s=g.utils.json_to_sheet(t);Object.keys(t[0]).forEach((i,m)=>{const x=g.utils.encode_cell({r:0,c:m});s[x]&&(s[x].s={fill:{fgColor:{rgb:"B8CCE4"}},font:{color:{rgb:"222222"},bold:!1},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}})});const d=g.utils.book_new();g.utils.book_append_sheet(d,s,"Predictive Analysis"),g.writeFile(d,"report_per_risk.xlsx",{bookType:"xlsx"})},W=(t,s)=>{s!=="clickaway"&&(E(!1),B(null))},v=()=>{throw y("Session expired. Please log in again.","error"),sessionStorage.removeItem("token"),L("/auth/login"),new Error("Unauthorized")},se=t=>{P(t),D(!0),O(null);try{const s=sessionStorage.getItem("token");if(!s)return v();const a=new Headers;a.append("authToken",s),a.append("Content-Type","application/json");const d={method:"POST",headers:a,body:JSON.stringify({id:t.id}),redirect:"follow"};fetch(`${G.rutaApi}employees_profile`,d).then(i=>i.status===401?v():i.json()).then(i=>{const m=i==null?void 0:i.dataEmployee;if(m){const x=m.salary_level??m.salaryLevel??null;O(x)}}).catch(i=>{console.error("Error fetching employee profile:",i)})}catch(s){console.error(s)}},U=()=>{D(!1),P(null)},ie=t=>{var s,a,d,i,m,x;return t?{brief:(((s=t.match(/Attrition Risk Brief:([\s\S]*?)(?=\*\*Risk Level|Risk Level:)/i))==null?void 0:s[1])||"").trim(),riskLevel:(((a=t.match(/Risk Level:([\s\S]*?)(?=\*\*Prioritized|Prioritized Risk Drivers:)/i))==null?void 0:a[1])||"").trim(),drivers:(((d=t.match(/Prioritized Risk Drivers:([\s\S]*?)(?=\*\*Sentiment|Sentiment Analysis:)/i))==null?void 0:d[1])||"").trim(),sentiment:(((i=t.match(/Sentiment Analysis:([\s\S]*?)(?=\*\*Overall|Overall Situation Assessment:)/i))==null?void 0:i[1])||"").trim(),assessment:(((m=t.match(/Overall Situation Assessment:([\s\S]*?)(?=\*\*Recommended|Recommended Actions:)/i))==null?void 0:m[1])||"").trim(),actions:re((((x=t.match(/Recommended Actions:([\s\S]*)/i))==null?void 0:x[1])||"").trim())}:{}},re=t=>{if(!t)return"";let s=String(t);const a=/(?:\*\*|__|<b>|<strong>)?\s*(Controllable by\s+(?:the\s+Client|Client|Us))\s*:?\s*(?:\*\*|__|<\/b>|<\/strong>)?/gi;return s=s.replace(a,(d,i)=>`<b>${i.trim()}:</b> `),s.trim()},j=t=>t?t.split(/\n|\. /).map(s=>s.replace(/\*\*|^-|\d+$/g,"").trim()).filter(s=>s.length>0):[],$=(t,s)=>{if(!t)return"";const a=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),d=new RegExp(`<b>\\s*${a}\\s*:<\\/b>([\\s\\S]*?)(?=<b>\\s*Controllable\\s+by\\s+(?:Us|the\\s+Client)\\s*:<\\/b>|$)`,"i"),i=t.match(d);return i?i[1].trim():""},r=l!=null&&l.text_ai?ie(l.text_ai):null,F=r!=null&&r.drivers?j(r.drivers):[],J=r!=null&&r.sentiment?j(r.sentiment):[],M=r!=null&&r.assessment?j(r.assessment):[],q=r!=null&&r.actions?j(r.actions):[],w=r!=null&&r.actions?$(r.actions,"Controllable by Us"):"",k=r!=null&&r.actions?$(r.actions,"Controllable by the Client"):"";return e.jsxs(e.Fragment,{children:[p&&e.jsx(xe,{open:Y,autoHideDuration:2e3,onClose:W,children:e.jsx(fe,{onClose:W,severity:p.severity,sx:{width:"100%"},children:p.msg})}),e.jsx(oe,{title:e.jsxs(n,{sx:{display:"flex",alignItems:"center",width:"100%",gap:{xs:2,sm:4},flexDirection:{xs:"column",sm:"row"},justifyContent:"space-between"},children:[e.jsx(o,{variant:"h5",children:"Show Risks"}),e.jsx(n,{sx:{flex:1,display:"flex",justifyContent:"center"},children:e.jsx(ae,{searchTerm:u,onSearchChange:N,onClearSearch:()=>N(""),placeholder:"Search by Name or Customer",width:250})}),e.jsx(_,{variant:"contained",color:"success",size:"small",onClick:te,sx:{minWidth:140},children:"Download Excel"})]}),children:e.jsx(ue,{sx:{width:"100%",overflowX:"auto"},children:e.jsxs(pe,{"aria-label":"simple table",sx:{whiteSpace:"nowrap"},children:[e.jsx(ge,{children:e.jsxs(K,{children:[e.jsx(h,{children:"No."}),e.jsx(h,{children:"Full Name"}),e.jsx(h,{children:"Customer"}),e.jsx(h,{children:"Perception"}),e.jsx(h,{children:"Analysis Result"}),e.jsx(h,{children:"Predictive Analysis"})]})}),e.jsx(be,{children:I.map((t,s)=>e.jsxs(K,{children:[e.jsx(h,{children:s+1}),e.jsx(h,{children:t.fullName}),e.jsx(h,{children:t.customer}),e.jsx(h,{children:t.calification}),e.jsx(h,{children:t.clasification}),e.jsx(h,{children:e.jsx(_,{size:"small",variant:"contained",sx:{mt:1,backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},onClick:()=>se(t),children:"Show Text"})})]},t.id))})]})})}),e.jsx(ce,{open:Z,onClose:U,maxWidth:"md",fullWidth:!0,children:l&&e.jsxs(e.Fragment,{children:[e.jsxs(de,{sx:{bgcolor:"#0D4B3B",color:"white",borderRadius:"8px 8px 0 0"},children:["ATTRITION RISK INSIGHTS - ",l.fullName,e.jsx(le,{label:l.clasification,color:l.clasification.toLowerCase().includes("high")?"error":l.clasification.toLowerCase().includes("medium")?"warning":"success",sx:{ml:2}})]}),e.jsxs(me,{dividers:!0,children:[e.jsx(o,{variant:"h6",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),e.jsxs(n,{sx:{display:"flex",gap:2,mb:2},children:[e.jsxs(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:2,bgcolor:"grey.100",borderRadius:2,flex:1,minWidth:100},children:[e.jsx(o,{sx:{fontSize:"2rem",mb:1},children:"ðŸ¢"}),e.jsx(o,{variant:"body1",fontWeight:"bold",align:"center",children:l.customer}),e.jsxs(n,{sx:{mt:3,display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(o,{sx:{fontSize:"2rem",mb:1},children:"ðŸ’²"}),e.jsx(o,{variant:"body1",fontWeight:"bold",align:"center",children:ee??"N/A"})]})]}),e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:l.calification==="Positive"?"ðŸ˜€":l.calification==="Negative"?"ðŸ˜ž":l.calification==="Neutral"?"ðŸ˜":"ðŸ¤¨"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:l.calification==="Positive"?"Positive":l.calification==="Negative"?"Negative":l.calification==="Neutral"?"Neutral":"No comments to analyze"}),J.length>0&&e.jsx(n,{children:J.map((t,s)=>e.jsx(o,{variant:"body2",sx:{color:"text.secondary",mb:.5},children:t},s))})]})]}),r&&F.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,flex:2,minWidth:280},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:l.clasification.toLowerCase().includes("high")?"âŒ":l.clasification.toLowerCase().includes("medium")?"âš ï¸":l.clasification.toLowerCase().includes("low")?"âœ…":"âšª"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"body1",fontWeight:"bold",gutterBottom:!0,children:"Prioritized Risk Drivers"}),F.map((t,s)=>e.jsxs(o,{variant:"body2",sx:{color:"text.secondary",mb:1},children:["â€¢ ",t]},s))]})]})]}),r&&M.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",gutterBottom:!0,children:"Overall Situation Assessment"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:M.map((t,s)=>e.jsx("li",{children:t},s))})]})]}),r&&(w||k)?e.jsxs(n,{children:[w&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ› ï¸"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by Us"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:R.sanitize(w)}})]})]}),k&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ¤"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",gutterBottom:!0,sx:{fontWeight:800},children:"Controllable by the Client"}),e.jsx(n,{sx:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:R.sanitize(k)}})]})]})]}):r&&q.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:2,p:2,bgcolor:"grey.100",borderRadius:2,mb:2},children:[e.jsx(o,{sx:{fontSize:"2rem",flexShrink:0,display:"flex",alignItems:"center"},children:"ðŸ“Š"}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(o,{variant:"h6",gutterBottom:!0,children:"Recommended Actions"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:q.map((t,s)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:R.sanitize(t)}},s))})]})]}),!r&&e.jsx(o,{children:"No analysis available."})]}),e.jsx(he,{children:e.jsx(_,{onClick:U,variant:"contained",sx:{backgroundColor:"#0D4B3B",color:"#ffffff","&:hover":{backgroundColor:"#0a3d32"}},children:"Close"})})]})})]})};export{et as default};
