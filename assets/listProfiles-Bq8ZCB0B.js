import{r as n,j as s}from"./index-B9c6G4RU.js";import{B as W,C as x}from"./BaseCard-B7xEBDih.js";import{c as T}from"./config-DOW8WNQj.js";import{B as _,T as m}from"./Box-DY5rMG6q.js";import{C as F}from"./CircularProgress-16haAPjs.js";import{A as G}from"./Alert-D64dzqcI.js";import{T as I,a as R,b as O,c as z,d as t,e as q}from"./TableRow-owgTIb2d.js";import{S as A}from"./Stack-C9oTHJwp.js";import{B as v}from"./Button-C_RbK71c.js";import{D as J,a as K,b as Q,c as V}from"./DialogTitle-C3bzlF34.js";import{D as N}from"./Divider-CID0eBmV.js";import{F as X,a as Y}from"./FormGroup-BqxMUshH.js";import{C as Z}from"./Checkbox-BL3HN6_N.js";import"./Card-DY8qMz7M.js";import"./Paper-Djww9Kda.js";import"./createSvgIcon-CuCLOW51.js";import"./useForkRef-bxOkU-Fv.js";import"./ButtonBase-DaiUm-zC.js";import"./CardContent-B0TW8JlS.js";import"./useSlot--7nv0rPO.js";import"./resolveComponentProps-lSV5xpUt.js";import"./Close-CwlFG3CA.js";import"./IconButton-Xr0163ay.js";import"./useId--VlEiZJx.js";import"./useThemeProps-D6hNwDDy.js";import"./Modal-sn2O3BuZ.js";import"./ownerDocument-DW-IO8s5.js";import"./createChainedFunction-BO_9K8Jh.js";import"./useFormControl-iTPikZFj.js";import"./SwitchBase-73nZb09u.js";import"./useControlled-knxWmPfA.js";import"./mergeSlotProps-CeBRw_gE.js";const _s=()=>{const[u,U]=n.useState([]),[j,w]=n.useState(!0),[g,h]=n.useState(null),[P,M]=n.useState([]),[$,S]=n.useState(!1),[l,E]=n.useState(null),[k,b]=n.useState([]);n.useEffect(()=>{(async()=>{try{const e=sessionStorage.getItem("token");if(!e){h("No token found. Please login again."),w(!1);return}const o=new Headers;o.append("authToken",e),o.append("Content-Type","application/json");const[a,p]=await Promise.all([fetch(`${T.rutaApi}show_list_profiles`,{method:"GET",headers:o}),fetch(`${T.rutaApi}users_system_list`,{method:"GET",headers:o})]);if(!a.ok){const i=await a.text();throw new Error(`Profiles HTTP ${a.status} - ${i}`)}if(!p.ok){const i=await p.text();throw new Error(`Users HTTP ${p.status} - ${i}`)}const d=await a.json(),c=await p.json();if(Array.isArray(d)){const i=d.map(f=>({...f,permissions:Array.isArray(f.permissions)?f.permissions:typeof f.permissions=="string"?f.permissions.replace(/[{}]/g,"").split(/\s*,\s*/).filter(Boolean):[]}));U(i)}else d!=null&&d.error?h(d.error):h("Unexpected profiles response structure");const D=Array.isArray(c)?c:Array.isArray(c==null?void 0:c.dataUsers)?c.dataUsers:[];M(D)}catch(e){console.error("Error fetching profiles:",e),h(e.message||"Error fetching profiles")}finally{w(!1)}})()},[]);const B=n.useMemo(()=>{const r=new Map;for(const e of P){const o=Number(e.systemProfile)||0;r.has(o)||r.set(o,[]),r.get(o).push(e)}return r},[P]),y=n.useMemo(()=>{const r=new Set;for(const e of u)(Array.isArray(e.permissions)?e.permissions:[]).forEach(a=>r.add(a));return Array.from(r).sort()},[u]),H=r=>{E(r),b(Array.isArray(r.permissions)?r.permissions:[]),S(!0)},C=()=>{S(!1),E(null),b([])},L=r=>{b(e=>e.includes(r)?e.filter(o=>o!==r):[...e,r])};return s.jsxs(W,{title:"Profiles",children:[j&&s.jsx(_,{py:4,display:"flex",justifyContent:"center",children:s.jsx(F,{size:40})}),g&&!j&&s.jsx(G,{severity:"error",sx:{mb:2},children:g}),!j&&!g&&s.jsxs(s.Fragment,{children:[s.jsx(I,{children:s.jsxs(R,{size:"small","aria-label":"profiles table",children:[s.jsx(O,{children:s.jsxs(z,{children:[s.jsx(t,{children:"ID"}),s.jsx(t,{children:"Name"}),s.jsx(t,{children:"Description"}),s.jsx(t,{children:"Permissions"}),s.jsx(t,{children:"Users"}),s.jsx(t,{children:"Status"}),s.jsx(t,{children:"Edit"})]})}),s.jsx(q,{children:u.map(r=>{const e=r.nameProfile||r.nameprofile||"(No name)",o=Array.isArray(r.permissions)?r.permissions:[],a=r.statusProfile??r.statusprofile,p=B.get(Number(r.id_profile))||[],d=new Set(o.map(i=>String(i).toLowerCase())),c=new Set(y.map(i=>String(i).toLowerCase())),D=c.size>0&&Array.from(c).every(i=>d.has(i));return s.jsxs(z,{hover:!0,children:[s.jsx(t,{children:r.id_profile}),s.jsx(t,{children:e}),s.jsx(t,{children:r.description}),s.jsx(t,{children:s.jsx(A,{direction:"row",spacing:.5,flexWrap:"wrap",children:D?s.jsx(x,{label:"All",size:"small",sx:{backgroundColor:"#0D4B3B",color:"#fff"}}):o.map(i=>s.jsx(x,{label:i,size:"small",variant:"outlined",sx:{borderColor:"#0D4B3B",color:"#0D4B3B"}},i))})}),s.jsx(t,{children:s.jsx(x,{label:String(p.length),size:"small",sx:{borderColor:"#0D4B3B",color:"#0D4B3B"},variant:"outlined"})}),s.jsx(t,{children:s.jsx(x,{label:a===1?"Active":"Inactive",size:"small",sx:a===1?{backgroundColor:"#0D4B3B",color:"#fff"}:void 0})}),s.jsx(t,{children:s.jsx(v,{variant:"outlined",size:"small",sx:{borderColor:"#0D4B3B",color:"#0D4B3B"},onClick:()=>H(r),children:"Edit"})})]},r.id_profile)})})]})}),s.jsxs(J,{open:$,onClose:C,maxWidth:"sm",fullWidth:!0,children:[s.jsx(K,{sx:{color:"#0D4B3B"},children:"Edit Profile"}),s.jsx(Q,{dividers:!0,children:l&&s.jsxs(_,{children:[s.jsx(m,{variant:"subtitle1",sx:{fontWeight:600},children:l.nameProfile||l.nameprofile}),s.jsx(m,{variant:"body2",color:"text.secondary",sx:{mb:1},children:l.description}),s.jsx(N,{sx:{my:2}}),s.jsx(m,{variant:"subtitle2",sx:{mb:1,color:"#0D4B3B"},children:"Permissions"}),y.length===0?s.jsx(m,{variant:"body2",children:"No permissions available."}):s.jsx(X,{children:s.jsx(A,{direction:"row",spacing:2,flexWrap:"wrap",children:y.map(r=>s.jsx(Y,{control:s.jsx(Z,{checked:k.includes(r),onChange:()=>L(r),sx:{color:"#0D4B3B","&.Mui-checked":{color:"#0D4B3B"}}}),label:s.jsx(x,{label:r,size:"small",variant:"outlined",sx:{borderColor:"#0D4B3B",color:"#0D4B3B"}})},r))})}),s.jsx(N,{sx:{my:2}}),s.jsx(m,{variant:"subtitle2",sx:{mb:1,color:"#0D4B3B"},children:"Users with this profile"}),s.jsxs(A,{spacing:.5,children:[(B.get(Number(l.id_profile))||[]).map(r=>s.jsxs(m,{variant:"body2",children:[r.first_name," ",r.last_name]},r.id_userSystem)),(B.get(Number(l.id_profile))||[]).length===0&&s.jsx(m,{variant:"body2",children:"No users assigned."})]})]})}),s.jsxs(V,{children:[s.jsx(v,{onClick:C,sx:{color:"#0D4B3B","&:hover":{backgroundColor:"#D9EDE3"}},children:"Close"}),s.jsx(v,{variant:"contained",sx:{backgroundColor:"#0D4B3B","&:hover":{backgroundColor:"#093828"}},onClick:()=>{console.log("Saving permissions for profile",l==null?void 0:l.id_profile,k),C()},children:"Save"})]})]})]})]})};export{_s as default};
